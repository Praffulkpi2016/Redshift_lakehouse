TRUNCATE table bronze_bec_ods_stg.PO_LINE_LOCATIONS_ALL;
INSERT INTO bronze_bec_ods_stg.PO_LINE_LOCATIONS_ALL (
  line_location_id,
  last_update_date,
  last_updated_by,
  po_header_id,
  po_line_id,
  last_update_login,
  creation_date,
  created_by,
  quantity,
  quantity_received,
  quantity_accepted,
  quantity_rejected,
  quantity_billed,
  quantity_cancelled,
  unit_meas_lookup_code,
  po_release_id,
  ship_to_location_id,
  ship_via_lookup_code,
  need_by_date,
  promised_date,
  last_accept_date,
  price_override,
  encumbered_flag,
  encumbered_date,
  unencumbered_quantity,
  fob_lookup_code,
  freight_terms_lookup_code,
  taxable_flag,
  tax_name,
  estimated_tax_amount,
  from_header_id,
  from_line_id,
  from_line_location_id,
  start_date,
  end_date,
  lead_time,
  lead_time_unit,
  price_discount,
  terms_id,
  approved_flag,
  approved_date,
  closed_flag,
  cancel_flag,
  cancelled_by,
  cancel_date,
  cancel_reason,
  firm_status_lookup_code,
  firm_date,
  attribute_category,
  attribute1,
  attribute2,
  attribute3,
  attribute4,
  attribute5,
  attribute6,
  attribute7,
  attribute8,
  attribute9,
  attribute10,
  unit_of_measure_class,
  encumber_now,
  attribute11,
  attribute12,
  attribute13,
  attribute14,
  attribute15,
  inspection_required_flag,
  receipt_required_flag,
  qty_rcv_tolerance,
  qty_rcv_exception_code,
  enforce_ship_to_location_code,
  allow_substitute_receipts_flag,
  days_early_receipt_allowed,
  days_late_receipt_allowed,
  receipt_days_exception_code,
  invoice_close_tolerance,
  receive_close_tolerance,
  ship_to_organization_id,
  shipment_num,
  source_shipment_id,
  shipment_type,
  closed_code,
  request_id,
  program_application_id,
  program_id,
  program_update_date,
  ussgl_transaction_code,
  government_context,
  receiving_routing_id,
  accrue_on_receipt_flag,
  closed_reason,
  closed_date,
  closed_by,
  org_id,
  quantity_shipped,
  global_attribute_category,
  global_attribute1,
  global_attribute2,
  global_attribute3,
  global_attribute4,
  global_attribute5,
  global_attribute6,
  global_attribute7,
  global_attribute8,
  global_attribute9,
  global_attribute10,
  global_attribute11,
  global_attribute12,
  global_attribute13,
  global_attribute14,
  global_attribute15,
  global_attribute16,
  global_attribute17,
  global_attribute18,
  global_attribute19,
  global_attribute20,
  country_of_origin_code,
  tax_user_override_flag,
  match_option,
  tax_code_id,
  calculate_tax_flag,
  change_promised_date_reason,
  note_to_receiver,
  secondary_quantity,
  secondary_unit_of_measure,
  preferred_grade,
  secondary_quantity_received,
  secondary_quantity_accepted,
  secondary_quantity_rejected,
  secondary_quantity_cancelled,
  vmi_flag,
  consigned_flag,
  retroactive_date,
  supplier_order_line_number,
  amount,
  amount_received,
  amount_billed,
  amount_cancelled,
  amount_rejected,
  amount_accepted,
  drop_ship_flag,
  sales_order_update_date,
  transaction_flow_header_id,
  final_match_flag,
  manual_price_change_flag,
  shipment_closed_date,
  closed_for_receiving_date,
  closed_for_invoice_date,
  secondary_quantity_shipped,
  value_basis,
  matching_basis,
  payment_type,
  description,
  work_approver_id,
  bid_payment_id,
  quantity_financed,
  amount_financed,
  quantity_recouped,
  amount_recouped,
  retainage_withheld_amount,
  retainage_released_amount,
  amount_shipped,
  outsourced_assembly,
  tax_attribute_update_code,
  original_shipment_id,
  lcm_flag,
  KCA_OPERATION,
  kca_seq_id,
  KCA_SEQ_DATE
)
(
  SELECT
    line_location_id,
    last_update_date,
    last_updated_by,
    po_header_id,
    po_line_id,
    last_update_login,
    creation_date,
    created_by,
    quantity,
    quantity_received,
    quantity_accepted,
    quantity_rejected,
    quantity_billed,
    quantity_cancelled,
    unit_meas_lookup_code,
    po_release_id,
    ship_to_location_id,
    ship_via_lookup_code,
    need_by_date,
    promised_date,
    last_accept_date,
    price_override,
    encumbered_flag,
    encumbered_date,
    unencumbered_quantity,
    fob_lookup_code,
    freight_terms_lookup_code,
    taxable_flag,
    tax_name,
    estimated_tax_amount,
    from_header_id,
    from_line_id,
    from_line_location_id,
    start_date,
    end_date,
    lead_time,
    lead_time_unit,
    price_discount,
    terms_id,
    approved_flag,
    approved_date,
    closed_flag,
    cancel_flag,
    cancelled_by,
    cancel_date,
    cancel_reason,
    firm_status_lookup_code,
    firm_date,
    attribute_category,
    attribute1,
    attribute2,
    attribute3,
    attribute4,
    attribute5,
    attribute6,
    attribute7,
    attribute8,
    attribute9,
    attribute10,
    unit_of_measure_class,
    encumber_now,
    attribute11,
    attribute12,
    attribute13,
    attribute14,
    attribute15,
    inspection_required_flag,
    receipt_required_flag,
    qty_rcv_tolerance,
    qty_rcv_exception_code,
    enforce_ship_to_location_code,
    allow_substitute_receipts_flag,
    days_early_receipt_allowed,
    days_late_receipt_allowed,
    receipt_days_exception_code,
    invoice_close_tolerance,
    receive_close_tolerance,
    ship_to_organization_id,
    shipment_num,
    source_shipment_id,
    shipment_type,
    closed_code,
    request_id,
    program_application_id,
    program_id,
    program_update_date,
    ussgl_transaction_code,
    government_context,
    receiving_routing_id,
    accrue_on_receipt_flag,
    closed_reason,
    closed_date,
    closed_by,
    org_id,
    quantity_shipped,
    global_attribute_category,
    global_attribute1,
    global_attribute2,
    global_attribute3,
    global_attribute4,
    global_attribute5,
    global_attribute6,
    global_attribute7,
    global_attribute8,
    global_attribute9,
    global_attribute10,
    global_attribute11,
    global_attribute12,
    global_attribute13,
    global_attribute14,
    global_attribute15,
    global_attribute16,
    global_attribute17,
    global_attribute18,
    global_attribute19,
    global_attribute20,
    country_of_origin_code,
    tax_user_override_flag,
    match_option,
    tax_code_id,
    calculate_tax_flag,
    change_promised_date_reason,
    note_to_receiver,
    secondary_quantity,
    secondary_unit_of_measure,
    preferred_grade,
    secondary_quantity_received,
    secondary_quantity_accepted,
    secondary_quantity_rejected,
    secondary_quantity_cancelled,
    vmi_flag,
    consigned_flag,
    retroactive_date,
    supplier_order_line_number,
    amount,
    amount_received,
    amount_billed,
    amount_cancelled,
    amount_rejected,
    amount_accepted,
    drop_ship_flag,
    sales_order_update_date,
    transaction_flow_header_id,
    final_match_flag,
    manual_price_change_flag,
    shipment_closed_date,
    closed_for_receiving_date,
    closed_for_invoice_date,
    secondary_quantity_shipped,
    value_basis,
    matching_basis,
    payment_type,
    description,
    work_approver_id,
    bid_payment_id,
    quantity_financed,
    amount_financed,
    quantity_recouped,
    amount_recouped,
    retainage_withheld_amount,
    retainage_released_amount,
    amount_shipped,
    outsourced_assembly,
    tax_attribute_update_code,
    original_shipment_id,
    lcm_flag,
    KCA_OPERATION,
    kca_seq_id,
    KCA_SEQ_DATE
  FROM bec_raw_dl_ext.po_line_locations_all
  WHERE
    kca_operation <> 'DELETE'
    AND COALESCE(kca_seq_id, '') <> ''
    AND (LINE_LOCATION_ID, kca_seq_id) IN (
      SELECT
        LINE_LOCATION_ID,
        MAX(kca_seq_id)
      FROM bec_raw_dl_ext.po_line_locations_all
      WHERE
        kca_operation <> 'DELETE' AND COALESCE(kca_seq_id, '') <> ''
      GROUP BY
        LINE_LOCATION_ID
    )
    AND (
      KCA_SEQ_DATE > (
        SELECT
          (
            executebegints - prune_days
          )
        FROM bec_etl_ctrl.batch_ods_info
        WHERE
          ods_table_name = 'po_line_locations_all'
      )
    )
);