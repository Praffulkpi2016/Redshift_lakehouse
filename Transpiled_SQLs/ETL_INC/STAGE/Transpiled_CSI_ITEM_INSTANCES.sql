TRUNCATE table bronze_bec_ods_stg.csi_item_instances;
INSERT INTO bronze_bec_ods_stg.csi_item_instances (
  INSTANCE_ID,
  INSTANCE_NUMBER,
  EXTERNAL_REFERENCE,
  INVENTORY_ITEM_ID,
  INVENTORY_REVISION,
  INV_MASTER_ORGANIZATION_ID,
  SERIAL_NUMBER,
  MFG_SERIAL_NUMBER_FLAG,
  LOT_NUMBER,
  QUANTITY,
  UNIT_OF_MEASURE,
  ACCOUNTING_CLASS_CODE,
  INSTANCE_CONDITION_ID,
  INSTANCE_STATUS_ID,
  CUSTOMER_VIEW_FLAG,
  MERCHANT_VIEW_FLAG,
  SELLABLE_FLAG,
  SYSTEM_ID,
  INSTANCE_TYPE_CODE,
  ACTIVE_START_DATE,
  ACTIVE_END_DATE,
  LOCATION_TYPE_CODE,
  LOCATION_ID,
  INV_ORGANIZATION_ID,
  INV_SUBINVENTORY_NAME,
  INV_LOCATOR_ID,
  PA_PROJECT_ID,
  PA_PROJECT_TASK_ID,
  IN_TRANSIT_ORDER_LINE_ID,
  WIP_JOB_ID,
  PO_ORDER_LINE_ID,
  LAST_OE_ORDER_LINE_ID,
  LAST_OE_RMA_LINE_ID,
  LAST_PO_PO_LINE_ID,
  LAST_OE_PO_NUMBER,
  LAST_WIP_JOB_ID,
  LAST_PA_PROJECT_ID,
  LAST_PA_TASK_ID,
  LAST_OE_AGREEMENT_ID,
  INSTALL_DATE,
  MANUALLY_CREATED_FLAG,
  RETURN_BY_DATE,
  ACTUAL_RETURN_DATE,
  CREATION_COMPLETE_FLAG,
  COMPLETENESS_FLAG,
  CONTEXT,
  ATTRIBUTE1,
  ATTRIBUTE2,
  ATTRIBUTE3,
  ATTRIBUTE4,
  ATTRIBUTE5,
  ATTRIBUTE6,
  ATTRIBUTE7,
  ATTRIBUTE8,
  ATTRIBUTE9,
  ATTRIBUTE10,
  ATTRIBUTE11,
  ATTRIBUTE12,
  ATTRIBUTE13,
  ATTRIBUTE14,
  ATTRIBUTE15,
  CREATED_BY,
  CREATION_DATE,
  LAST_UPDATED_BY,
  LAST_UPDATE_DATE,
  LAST_UPDATE_LOGIN,
  OBJECT_VERSION_NUMBER,
  SECURITY_GROUP_ID,
  LAST_TXN_LINE_DETAIL_ID,
  INSTALL_LOCATION_TYPE_CODE,
  INSTALL_LOCATION_ID,
  INSTANCE_USAGE_CODE,
  OWNER_PARTY_SOURCE_TABLE,
  OWNER_PARTY_ID,
  OWNER_PARTY_ACCOUNT_ID,
  LAST_VLD_ORGANIZATION_ID,
  MIGRATED_FLAG,
  REQUEST_ID,
  PROGRAM_APPLICATION_ID,
  PROGRAM_ID,
  PROGRAM_UPDATE_DATE,
  CONFIG_INST_HDR_ID,
  CONFIG_INST_REV_NUM,
  CONFIG_INST_ITEM_ID,
  CONFIG_VALID_STATUS,
  INSTANCE_DESCRIPTION,
  LAST_PURGE_DATE,
  ATTRIBUTE16,
  ATTRIBUTE17,
  ATTRIBUTE18,
  ATTRIBUTE19,
  ATTRIBUTE20,
  ATTRIBUTE21,
  ATTRIBUTE22,
  ATTRIBUTE23,
  ATTRIBUTE24,
  ATTRIBUTE25,
  ATTRIBUTE26,
  ATTRIBUTE27,
  ATTRIBUTE28,
  ATTRIBUTE29,
  ATTRIBUTE30,
  NETWORK_ASSET_FLAG,
  MAINTAINABLE_FLAG,
  PN_LOCATION_ID,
  ASSET_CRITICALITY_CODE,
  CATEGORY_ID,
  EQUIPMENT_GEN_OBJECT_ID,
  INSTANTIATION_FLAG,
  LINEAR_LOCATION_ID,
  OPERATIONAL_LOG_FLAG,
  CHECKIN_STATUS,
  SUPPLIER_WARRANTY_EXP_DATE,
  PURCHASE_UNIT_PRICE,
  PURCHASE_CURRENCY_CODE,
  PAYABLES_UNIT_PRICE,
  PAYABLES_CURRENCY_CODE,
  SALES_UNIT_PRICE,
  SALES_CURRENCY_CODE,
  OPERATIONAL_STATUS_CODE,
  SOURCE_CODE,
  ROUTE_UPDATE_WO_FLAG,
  COST_UPDATE_WO_FLAG,
  ROUTE_COST_EQUAL_FLAG,
  LINEAR_ASSET,
  SEGMENTED,
  ROUTE_QUALITY_RESULT_FLAG,
  ESRI_FEATURE,
  NO_MEASURES_LA,
  ROUTE_LAYER_ID,
  IN_SERVICE_DATE,
  IOT_SYNC_DATE,
  KCA_OPERATION,
  kca_seq_id,
  kca_seq_date
)
(
  SELECT
    INSTANCE_ID,
    INSTANCE_NUMBER,
    EXTERNAL_REFERENCE,
    INVENTORY_ITEM_ID,
    INVENTORY_REVISION,
    INV_MASTER_ORGANIZATION_ID,
    SERIAL_NUMBER,
    MFG_SERIAL_NUMBER_FLAG,
    LOT_NUMBER,
    QUANTITY,
    UNIT_OF_MEASURE,
    ACCOUNTING_CLASS_CODE,
    INSTANCE_CONDITION_ID,
    INSTANCE_STATUS_ID,
    CUSTOMER_VIEW_FLAG,
    MERCHANT_VIEW_FLAG,
    SELLABLE_FLAG,
    SYSTEM_ID,
    INSTANCE_TYPE_CODE,
    ACTIVE_START_DATE,
    ACTIVE_END_DATE,
    LOCATION_TYPE_CODE,
    LOCATION_ID,
    INV_ORGANIZATION_ID,
    INV_SUBINVENTORY_NAME,
    INV_LOCATOR_ID,
    PA_PROJECT_ID,
    PA_PROJECT_TASK_ID,
    IN_TRANSIT_ORDER_LINE_ID,
    WIP_JOB_ID,
    PO_ORDER_LINE_ID,
    LAST_OE_ORDER_LINE_ID,
    LAST_OE_RMA_LINE_ID,
    LAST_PO_PO_LINE_ID,
    LAST_OE_PO_NUMBER,
    LAST_WIP_JOB_ID,
    LAST_PA_PROJECT_ID,
    LAST_PA_TASK_ID,
    LAST_OE_AGREEMENT_ID,
    INSTALL_DATE,
    MANUALLY_CREATED_FLAG,
    RETURN_BY_DATE,
    ACTUAL_RETURN_DATE,
    CREATION_COMPLETE_FLAG,
    COMPLETENESS_FLAG,
    CONTEXT,
    ATTRIBUTE1,
    ATTRIBUTE2,
    ATTRIBUTE3,
    ATTRIBUTE4,
    ATTRIBUTE5,
    ATTRIBUTE6,
    ATTRIBUTE7,
    ATTRIBUTE8,
    ATTRIBUTE9,
    ATTRIBUTE10,
    ATTRIBUTE11,
    ATTRIBUTE12,
    ATTRIBUTE13,
    ATTRIBUTE14,
    ATTRIBUTE15,
    CREATED_BY,
    CREATION_DATE,
    LAST_UPDATED_BY,
    LAST_UPDATE_DATE,
    LAST_UPDATE_LOGIN,
    OBJECT_VERSION_NUMBER,
    SECURITY_GROUP_ID,
    LAST_TXN_LINE_DETAIL_ID,
    INSTALL_LOCATION_TYPE_CODE,
    INSTALL_LOCATION_ID,
    INSTANCE_USAGE_CODE,
    OWNER_PARTY_SOURCE_TABLE,
    OWNER_PARTY_ID,
    OWNER_PARTY_ACCOUNT_ID,
    LAST_VLD_ORGANIZATION_ID,
    MIGRATED_FLAG,
    REQUEST_ID,
    PROGRAM_APPLICATION_ID,
    PROGRAM_ID,
    PROGRAM_UPDATE_DATE,
    CONFIG_INST_HDR_ID,
    CONFIG_INST_REV_NUM,
    CONFIG_INST_ITEM_ID,
    CONFIG_VALID_STATUS,
    INSTANCE_DESCRIPTION,
    LAST_PURGE_DATE,
    ATTRIBUTE16,
    ATTRIBUTE17,
    ATTRIBUTE18,
    ATTRIBUTE19,
    ATTRIBUTE20,
    ATTRIBUTE21,
    ATTRIBUTE22,
    ATTRIBUTE23,
    ATTRIBUTE24,
    ATTRIBUTE25,
    ATTRIBUTE26,
    ATTRIBUTE27,
    ATTRIBUTE28,
    ATTRIBUTE29,
    ATTRIBUTE30,
    NETWORK_ASSET_FLAG,
    MAINTAINABLE_FLAG,
    PN_LOCATION_ID,
    ASSET_CRITICALITY_CODE,
    CATEGORY_ID,
    EQUIPMENT_GEN_OBJECT_ID,
    INSTANTIATION_FLAG,
    LINEAR_LOCATION_ID,
    OPERATIONAL_LOG_FLAG,
    CHECKIN_STATUS,
    SUPPLIER_WARRANTY_EXP_DATE,
    PURCHASE_UNIT_PRICE,
    PURCHASE_CURRENCY_CODE,
    PAYABLES_UNIT_PRICE,
    PAYABLES_CURRENCY_CODE,
    SALES_UNIT_PRICE,
    SALES_CURRENCY_CODE,
    OPERATIONAL_STATUS_CODE,
    SOURCE_CODE,
    ROUTE_UPDATE_WO_FLAG,
    COST_UPDATE_WO_FLAG,
    ROUTE_COST_EQUAL_FLAG,
    LINEAR_ASSET,
    SEGMENTED,
    ROUTE_QUALITY_RESULT_FLAG,
    ESRI_FEATURE,
    NO_MEASURES_LA,
    ROUTE_LAYER_ID,
    IN_SERVICE_DATE,
    IOT_SYNC_DATE,
    KCA_OPERATION,
    kca_seq_id,
    kca_seq_date
  FROM bec_raw_dl_ext.csi_item_instances
  WHERE
    kca_operation <> 'DELETE'
    AND COALESCE(kca_seq_id, '') <> ''
    AND (COALESCE(INSTANCE_ID, 0), kca_seq_id) IN (
      SELECT
        COALESCE(INSTANCE_ID, 0) AS INSTANCE_ID,
        MAX(kca_seq_id)
      FROM bec_raw_dl_ext.csi_item_instances
      WHERE
        kca_operation <> 'DELETE' AND COALESCE(kca_seq_id, '') <> ''
      GROUP BY
        COALESCE(INSTANCE_ID, 0)
    )
    AND kca_seq_date > (
      SELECT
        (
          executebegints - prune_days
        )
      FROM bec_etl_ctrl.batch_ods_info
      WHERE
        ods_table_name = 'csi_item_instances'
    )
);