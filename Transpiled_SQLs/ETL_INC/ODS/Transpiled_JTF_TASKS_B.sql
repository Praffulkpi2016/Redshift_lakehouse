/* Delete Records */
DELETE FROM silver_bec_ods.JTF_TASKS_B
WHERE
  (
    COALESCE(TASK_ID, 0)
  ) IN (
    SELECT
      COALESCE(stg.TASK_ID, 0) AS TASK_ID
    FROM silver_bec_ods.JTF_TASKS_B AS ods, bronze_bec_ods_stg.JTF_TASKS_B AS stg
    WHERE
      COALESCE(ods.TASK_ID, 0) = COALESCE(stg.TASK_ID, 0)
      AND stg.kca_operation IN ('INSERT', 'UPDATE')
  );
/* Insert records */
INSERT INTO silver_bec_ods.JTF_TASKS_B (
  TASK_ID,
  CREATED_BY,
  CREATION_DATE,
  LAST_UPDATED_BY,
  LAST_UPDATE_DATE,
  LAST_UPDATE_LOGIN,
  OBJECT_VERSION_NUMBER,
  TASK_NUMBER,
  TASK_TYPE_ID,
  TASK_STATUS_ID,
  TASK_PRIORITY_ID,
  OWNER_ID,
  OWNER_TYPE_CODE,
  OWNER_TERRITORY_ID,
  ASSIGNED_BY_ID,
  CUST_ACCOUNT_ID,
  CUSTOMER_ID,
  ADDRESS_ID,
  PLANNED_START_DATE,
  PLANNED_END_DATE,
  SCHEDULED_START_DATE,
  SCHEDULED_END_DATE,
  ACTUAL_START_DATE,
  ACTUAL_END_DATE,
  SOURCE_OBJECT_TYPE_CODE,
  TIMEZONE_ID,
  SOURCE_OBJECT_ID,
  SOURCE_OBJECT_NAME,
  DURATION,
  DURATION_UOM,
  PLANNED_EFFORT,
  PLANNED_EFFORT_UOM,
  ACTUAL_EFFORT,
  ACTUAL_EFFORT_UOM,
  PERCENTAGE_COMPLETE,
  REASON_CODE,
  PRIVATE_FLAG,
  PUBLISH_FLAG,
  RESTRICT_CLOSURE_FLAG,
  MULTI_BOOKED_FLAG,
  MILESTONE_FLAG,
  HOLIDAY_FLAG,
  BILLABLE_FLAG,
  BOUND_MODE_CODE,
  SOFT_BOUND_FLAG,
  WORKFLOW_PROCESS_ID,
  NOTIFICATION_FLAG,
  NOTIFICATION_PERIOD,
  NOTIFICATION_PERIOD_UOM,
  PARENT_TASK_ID,
  RECURRENCE_RULE_ID,
  ALARM_START,
  ALARM_START_UOM,
  ALARM_ON,
  ALARM_COUNT,
  ALARM_FIRED_COUNT,
  ALARM_INTERVAL,
  ALARM_INTERVAL_UOM,
  DELETED_FLAG,
  PALM_FLAG,
  WINCE_FLAG,
  LAPTOP_FLAG,
  DEVICE1_FLAG,
  DEVICE2_FLAG,
  DEVICE3_FLAG,
  COSTS,
  CURRENCY_CODE,
  ORG_ID,
  ESCALATION_LEVEL,
  ATTRIBUTE1,
  ATTRIBUTE2,
  ATTRIBUTE3,
  ATTRIBUTE4,
  ATTRIBUTE5,
  ATTRIBUTE6,
  ATTRIBUTE7,
  ATTRIBUTE8,
  ATTRIBUTE9,
  ATTRIBUTE10,
  ATTRIBUTE11,
  ATTRIBUTE12,
  ATTRIBUTE13,
  ATTRIBUTE14,
  ATTRIBUTE15,
  ATTRIBUTE_CATEGORY,
  SECURITY_GROUP_ID,
  ORIG_SYSTEM_REFERENCE,
  ORIG_SYSTEM_REFERENCE_ID,
  UPDATE_STATUS_FLAG,
  CALENDAR_START_DATE,
  CALENDAR_END_DATE,
  DATE_SELECTED,
  TEMPLATE_ID,
  TEMPLATE_GROUP_ID,
  OBJECT_CHANGED_DATE,
  TASK_CONFIRMATION_STATUS,
  TASK_CONFIRMATION_COUNTER,
  TASK_SPLIT_FLAG,
  OPEN_FLAG,
  ENTITY,
  CHILD_POSITION,
  CHILD_SEQUENCE_NUM,
  LOCATION_ID,
  CRITICAL_TASK_FLAG,
  CUST_IMP_LEVEL,
  FOLLOW_UP_TASK_FLAG,
  BASE_TASK_ID,
  KCA_OPERATION,
  IS_DELETED_FLG,
  kca_seq_ID,
  kca_seq_date
)
(
  SELECT
    TASK_ID,
    CREATED_BY,
    CREATION_DATE,
    LAST_UPDATED_BY,
    LAST_UPDATE_DATE,
    LAST_UPDATE_LOGIN,
    OBJECT_VERSION_NUMBER,
    TASK_NUMBER,
    TASK_TYPE_ID,
    TASK_STATUS_ID,
    TASK_PRIORITY_ID,
    OWNER_ID,
    OWNER_TYPE_CODE,
    OWNER_TERRITORY_ID,
    ASSIGNED_BY_ID,
    CUST_ACCOUNT_ID,
    CUSTOMER_ID,
    ADDRESS_ID,
    PLANNED_START_DATE,
    PLANNED_END_DATE,
    SCHEDULED_START_DATE,
    SCHEDULED_END_DATE,
    ACTUAL_START_DATE,
    ACTUAL_END_DATE,
    SOURCE_OBJECT_TYPE_CODE,
    TIMEZONE_ID,
    SOURCE_OBJECT_ID,
    SOURCE_OBJECT_NAME,
    DURATION,
    DURATION_UOM,
    PLANNED_EFFORT,
    PLANNED_EFFORT_UOM,
    ACTUAL_EFFORT,
    ACTUAL_EFFORT_UOM,
    PERCENTAGE_COMPLETE,
    REASON_CODE,
    PRIVATE_FLAG,
    PUBLISH_FLAG,
    RESTRICT_CLOSURE_FLAG,
    MULTI_BOOKED_FLAG,
    MILESTONE_FLAG,
    HOLIDAY_FLAG,
    BILLABLE_FLAG,
    BOUND_MODE_CODE,
    SOFT_BOUND_FLAG,
    WORKFLOW_PROCESS_ID,
    NOTIFICATION_FLAG,
    NOTIFICATION_PERIOD,
    NOTIFICATION_PERIOD_UOM,
    PARENT_TASK_ID,
    RECURRENCE_RULE_ID,
    ALARM_START,
    ALARM_START_UOM,
    ALARM_ON,
    ALARM_COUNT,
    ALARM_FIRED_COUNT,
    ALARM_INTERVAL,
    ALARM_INTERVAL_UOM,
    DELETED_FLAG,
    PALM_FLAG,
    WINCE_FLAG,
    LAPTOP_FLAG,
    DEVICE1_FLAG,
    DEVICE2_FLAG,
    DEVICE3_FLAG,
    COSTS,
    CURRENCY_CODE,
    ORG_ID,
    ESCALATION_LEVEL,
    ATTRIBUTE1,
    ATTRIBUTE2,
    ATTRIBUTE3,
    ATTRIBUTE4,
    ATTRIBUTE5,
    ATTRIBUTE6,
    ATTRIBUTE7,
    ATTRIBUTE8,
    ATTRIBUTE9,
    ATTRIBUTE10,
    ATTRIBUTE11,
    ATTRIBUTE12,
    ATTRIBUTE13,
    ATTRIBUTE14,
    ATTRIBUTE15,
    ATTRIBUTE_CATEGORY,
    SECURITY_GROUP_ID,
    ORIG_SYSTEM_REFERENCE,
    ORIG_SYSTEM_REFERENCE_ID,
    UPDATE_STATUS_FLAG,
    CALENDAR_START_DATE,
    CALENDAR_END_DATE,
    DATE_SELECTED,
    TEMPLATE_ID,
    TEMPLATE_GROUP_ID,
    OBJECT_CHANGED_DATE,
    TASK_CONFIRMATION_STATUS,
    TASK_CONFIRMATION_COUNTER,
    TASK_SPLIT_FLAG,
    OPEN_FLAG,
    ENTITY,
    CHILD_POSITION,
    CHILD_SEQUENCE_NUM,
    LOCATION_ID,
    CRITICAL_TASK_FLAG,
    CUST_IMP_LEVEL,
    FOLLOW_UP_TASK_FLAG,
    BASE_TASK_ID,
    KCA_OPERATION,
    'N' AS IS_DELETED_FLG,
    CAST(NULLIF(KCA_SEQ_ID, '') AS DECIMAL(36, 0)) AS KCA_SEQ_ID,
    kca_seq_date
  FROM bronze_bec_ods_stg.JTF_TASKS_B
  WHERE
    kca_operation IN ('INSERT', 'UPDATE')
    AND (COALESCE(TASK_ID, 0), kca_seq_ID) IN (
      SELECT
        COALESCE(TASK_ID, 0) AS TASK_ID,
        MAX(kca_seq_ID) AS kca_seq_ID
      FROM bronze_bec_ods_stg.JTF_TASKS_B
      WHERE
        kca_operation IN ('INSERT', 'UPDATE')
      GROUP BY
        COALESCE(TASK_ID, 0)
    )
);
/* Soft delete */
UPDATE silver_bec_ods.JTF_TASKS_B SET IS_DELETED_FLG = 'N';
UPDATE silver_bec_ods.JTF_TASKS_B SET IS_DELETED_FLG = 'Y'
WHERE
  (
    TASK_ID
  ) IN (
    SELECT
      TASK_ID
    FROM bec_raw_dl_ext.JTF_TASKS_B
    WHERE
      (TASK_ID, KCA_SEQ_ID) IN (
        SELECT
          TASK_ID,
          MAX(KCA_SEQ_ID) AS KCA_SEQ_ID
        FROM bec_raw_dl_ext.JTF_TASKS_B
        GROUP BY
          TASK_ID
      )
      AND kca_operation = 'DELETE'
  );
UPDATE bec_etl_ctrl.batch_ods_info SET last_refresh_date = CURRENT_TIMESTAMP()
WHERE
  ods_table_name = 'jtf_tasks_b';