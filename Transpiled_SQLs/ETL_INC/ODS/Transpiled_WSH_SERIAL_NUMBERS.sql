/* Delete Records */
DELETE FROM silver_bec_ods.WSH_SERIAL_NUMBERS
WHERE
  (COALESCE(DELIVERY_DETAIL_ID, 0), COALESCE(FM_SERIAL_NUMBER, 'NA')) IN (
    SELECT
      COALESCE(stg.DELIVERY_DETAIL_ID, 0) AS DELIVERY_DETAIL_ID,
      COALESCE(stg.FM_SERIAL_NUMBER, 'NA') AS FM_SERIAL_NUMBER
    FROM silver_bec_ods.wsh_serial_numbers AS ods, bronze_bec_ods_stg.wsh_serial_numbers AS stg
    WHERE
      COALESCE(ods.DELIVERY_DETAIL_ID, 0) = COALESCE(stg.DELIVERY_DETAIL_ID, 0)
      AND COALESCE(ods.FM_SERIAL_NUMBER, 'NA') = COALESCE(stg.FM_SERIAL_NUMBER, 'NA')
      AND stg.kca_operation IN ('INSERT', 'UPDATE')
  );
/* Insert records */
INSERT INTO silver_bec_ods.wsh_serial_numbers (
  DELIVERY_DETAIL_ID,
  FM_SERIAL_NUMBER,
  TO_SERIAL_NUMBER,
  QUANTITY,
  CREATION_DATE,
  CREATED_BY,
  LAST_UPDATE_DATE,
  LAST_UPDATED_BY,
  ATTRIBUTE_CATEGORY,
  ATTRIBUTE1,
  ATTRIBUTE2,
  ATTRIBUTE3,
  ATTRIBUTE4,
  ATTRIBUTE5,
  ATTRIBUTE6,
  ATTRIBUTE7,
  ATTRIBUTE8,
  ATTRIBUTE9,
  ATTRIBUTE10,
  ATTRIBUTE11,
  ATTRIBUTE12,
  ATTRIBUTE13,
  ATTRIBUTE14,
  ATTRIBUTE15,
  LAST_UPDATE_LOGIN,
  SERIAL_ATTRIBUTE_CATEGORY,
  C_ATTRIBUTE1,
  C_ATTRIBUTE2,
  C_ATTRIBUTE3,
  C_ATTRIBUTE4,
  C_ATTRIBUTE5,
  C_ATTRIBUTE6,
  C_ATTRIBUTE7,
  C_ATTRIBUTE8,
  C_ATTRIBUTE9,
  C_ATTRIBUTE10,
  C_ATTRIBUTE11,
  C_ATTRIBUTE12,
  C_ATTRIBUTE13,
  C_ATTRIBUTE14,
  C_ATTRIBUTE15,
  C_ATTRIBUTE16,
  C_ATTRIBUTE17,
  C_ATTRIBUTE18,
  C_ATTRIBUTE19,
  C_ATTRIBUTE20,
  D_ATTRIBUTE1,
  D_ATTRIBUTE2,
  D_ATTRIBUTE3,
  D_ATTRIBUTE4,
  D_ATTRIBUTE5,
  D_ATTRIBUTE6,
  D_ATTRIBUTE7,
  D_ATTRIBUTE8,
  D_ATTRIBUTE9,
  D_ATTRIBUTE10,
  N_ATTRIBUTE1,
  N_ATTRIBUTE2,
  N_ATTRIBUTE3,
  N_ATTRIBUTE4,
  N_ATTRIBUTE5,
  N_ATTRIBUTE6,
  N_ATTRIBUTE7,
  N_ATTRIBUTE8,
  N_ATTRIBUTE9,
  N_ATTRIBUTE10,
  TERRITORY_CODE,
  TIME_SINCE_NEW,
  CYCLES_SINCE_NEW,
  TIME_SINCE_OVERHAUL,
  CYCLES_SINCE_OVERHAUL,
  TIME_SINCE_REPAIR,
  CYCLES_SINCE_REPAIR,
  TIME_SINCE_VISIT,
  CYCLES_SINCE_VISIT,
  TIME_SINCE_MARK,
  CYCLES_SINCE_MARK,
  NUMBER_OF_REPAIRS,
  VENDOR_SERIAL_NUMBER,
  VENDOR_LOT_NUMBER,
  KCA_OPERATION,
  IS_DELETED_FLG,
  kca_seq_ID,
  kca_seq_date
)
(
  SELECT
    DELIVERY_DETAIL_ID,
    FM_SERIAL_NUMBER,
    TO_SERIAL_NUMBER,
    QUANTITY,
    CREATION_DATE,
    CREATED_BY,
    LAST_UPDATE_DATE,
    LAST_UPDATED_BY,
    ATTRIBUTE_CATEGORY,
    ATTRIBUTE1,
    ATTRIBUTE2,
    ATTRIBUTE3,
    ATTRIBUTE4,
    ATTRIBUTE5,
    ATTRIBUTE6,
    ATTRIBUTE7,
    ATTRIBUTE8,
    ATTRIBUTE9,
    ATTRIBUTE10,
    ATTRIBUTE11,
    ATTRIBUTE12,
    ATTRIBUTE13,
    ATTRIBUTE14,
    ATTRIBUTE15,
    LAST_UPDATE_LOGIN,
    SERIAL_ATTRIBUTE_CATEGORY,
    C_ATTRIBUTE1,
    C_ATTRIBUTE2,
    C_ATTRIBUTE3,
    C_ATTRIBUTE4,
    C_ATTRIBUTE5,
    C_ATTRIBUTE6,
    C_ATTRIBUTE7,
    C_ATTRIBUTE8,
    C_ATTRIBUTE9,
    C_ATTRIBUTE10,
    C_ATTRIBUTE11,
    C_ATTRIBUTE12,
    C_ATTRIBUTE13,
    C_ATTRIBUTE14,
    C_ATTRIBUTE15,
    C_ATTRIBUTE16,
    C_ATTRIBUTE17,
    C_ATTRIBUTE18,
    C_ATTRIBUTE19,
    C_ATTRIBUTE20,
    D_ATTRIBUTE1,
    D_ATTRIBUTE2,
    D_ATTRIBUTE3,
    D_ATTRIBUTE4,
    D_ATTRIBUTE5,
    D_ATTRIBUTE6,
    D_ATTRIBUTE7,
    D_ATTRIBUTE8,
    D_ATTRIBUTE9,
    D_ATTRIBUTE10,
    N_ATTRIBUTE1,
    N_ATTRIBUTE2,
    N_ATTRIBUTE3,
    N_ATTRIBUTE4,
    N_ATTRIBUTE5,
    N_ATTRIBUTE6,
    N_ATTRIBUTE7,
    N_ATTRIBUTE8,
    N_ATTRIBUTE9,
    N_ATTRIBUTE10,
    TERRITORY_CODE,
    TIME_SINCE_NEW,
    CYCLES_SINCE_NEW,
    TIME_SINCE_OVERHAUL,
    CYCLES_SINCE_OVERHAUL,
    TIME_SINCE_REPAIR,
    CYCLES_SINCE_REPAIR,
    TIME_SINCE_VISIT,
    CYCLES_SINCE_VISIT,
    TIME_SINCE_MARK,
    CYCLES_SINCE_MARK,
    NUMBER_OF_REPAIRS,
    VENDOR_SERIAL_NUMBER,
    VENDOR_LOT_NUMBER,
    KCA_OPERATION,
    'N' AS IS_DELETED_FLG,
    CAST(NULLIF(KCA_SEQ_ID, '') AS DECIMAL(36, 0)) AS KCA_SEQ_ID,
    kca_seq_date
  FROM bronze_bec_ods_stg.wsh_serial_numbers
  WHERE
    kca_operation IN ('INSERT', 'UPDATE')
    AND (COALESCE(DELIVERY_DETAIL_ID, 0), COALESCE(FM_SERIAL_NUMBER, 'NA'), kca_seq_ID) IN (
      SELECT
        COALESCE(DELIVERY_DETAIL_ID, 0) AS DELIVERY_DETAIL_ID,
        COALESCE(FM_SERIAL_NUMBER, 'NA') AS FM_SERIAL_NUMBER,
        MAX(kca_seq_ID) AS kca_seq_ID
      FROM bronze_bec_ods_stg.wsh_serial_numbers
      WHERE
        kca_operation IN ('INSERT', 'UPDATE')
      GROUP BY
        COALESCE(DELIVERY_DETAIL_ID, 0),
        COALESCE(FM_SERIAL_NUMBER, 'NA')
    )
);
/* Soft delete */
UPDATE silver_bec_ods.wsh_serial_numbers SET IS_DELETED_FLG = 'N';
UPDATE silver_bec_ods.wsh_serial_numbers SET IS_DELETED_FLG = 'Y'
WHERE
  (DELIVERY_DETAIL_ID, FM_SERIAL_NUMBER) IN (
    SELECT
      DELIVERY_DETAIL_ID,
      FM_SERIAL_NUMBER
    FROM bec_raw_dl_ext.wsh_serial_numbers
    WHERE
      (DELIVERY_DETAIL_ID, FM_SERIAL_NUMBER, KCA_SEQ_ID) IN (
        SELECT
          DELIVERY_DETAIL_ID,
          FM_SERIAL_NUMBER,
          MAX(KCA_SEQ_ID) AS KCA_SEQ_ID
        FROM bec_raw_dl_ext.wsh_serial_numbers
        GROUP BY
          DELIVERY_DETAIL_ID,
          FM_SERIAL_NUMBER
      )
      AND kca_operation = 'DELETE'
  );
UPDATE bec_etl_ctrl.batch_ods_info SET last_refresh_date = CURRENT_TIMESTAMP()
WHERE
  ods_table_name = 'wsh_serial_numbers';