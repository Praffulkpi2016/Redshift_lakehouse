/*
# Copyright(c) 2022 KPI Partners, Inc. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# author: KPI Partners, Inc.
# version: 2022.06
# description: This script represents Incremental load approach for stage.
# File Version: KPI v1.0
*/
begin;

truncate
	table bec_ods_stg.po_distributions_all;

insert
	into
	bec_ods_stg.po_distributions_all
(
PO_DISTRIBUTION_ID,
LAST_UPDATE_DATE,
LAST_UPDATED_BY,
PO_HEADER_ID,
PO_LINE_ID,
LINE_LOCATION_ID,
SET_OF_BOOKS_ID,
CODE_COMBINATION_ID,
QUANTITY_ORDERED,
LAST_UPDATE_LOGIN,
CREATION_DATE,
CREATED_BY,
PO_RELEASE_ID,
QUANTITY_DELIVERED,
QUANTITY_BILLED,
QUANTITY_CANCELLED,
REQ_HEADER_REFERENCE_NUM,
REQ_LINE_REFERENCE_NUM,
REQ_DISTRIBUTION_ID,
DELIVER_TO_LOCATION_ID,
DELIVER_TO_PERSON_ID,
RATE_DATE,
RATE,
AMOUNT_BILLED,
ACCRUED_FLAG,
ENCUMBERED_FLAG,
ENCUMBERED_AMOUNT,
UNENCUMBERED_QUANTITY,
UNENCUMBERED_AMOUNT,
FAILED_FUNDS_LOOKUP_CODE,
GL_ENCUMBERED_DATE,
GL_ENCUMBERED_PERIOD_NAME,
GL_CANCELLED_DATE,
DESTINATION_TYPE_CODE,
DESTINATION_ORGANIZATION_ID,
DESTINATION_SUBINVENTORY,
ATTRIBUTE_CATEGORY,
ATTRIBUTE1,
ATTRIBUTE2,
ATTRIBUTE3,
ATTRIBUTE4,
ATTRIBUTE5,
ATTRIBUTE6,
ATTRIBUTE7,
ATTRIBUTE8,
ATTRIBUTE9,
ATTRIBUTE10,
ATTRIBUTE11,
ATTRIBUTE12,
ATTRIBUTE13,
ATTRIBUTE14,
ATTRIBUTE15,
WIP_ENTITY_ID,
WIP_OPERATION_SEQ_NUM,
WIP_RESOURCE_SEQ_NUM,
WIP_REPETITIVE_SCHEDULE_ID,
WIP_LINE_ID,
BOM_RESOURCE_ID,
BUDGET_ACCOUNT_ID,
ACCRUAL_ACCOUNT_ID,
VARIANCE_ACCOUNT_ID,
PREVENT_ENCUMBRANCE_FLAG,
USSGL_TRANSACTION_CODE,
GOVERNMENT_CONTEXT,
DESTINATION_CONTEXT,
DISTRIBUTION_NUM,
SOURCE_DISTRIBUTION_ID,
REQUEST_ID,
PROGRAM_APPLICATION_ID,
PROGRAM_ID,
PROGRAM_UPDATE_DATE,
PROJECT_ID,
TASK_ID,
EXPENDITURE_TYPE,
PROJECT_ACCOUNTING_CONTEXT,
EXPENDITURE_ORGANIZATION_ID,
GL_CLOSED_DATE,
ACCRUE_ON_RECEIPT_FLAG,
EXPENDITURE_ITEM_DATE,
ORG_ID,
KANBAN_CARD_ID,
AWARD_ID,
MRC_RATE_DATE,
MRC_RATE,
MRC_ENCUMBERED_AMOUNT,
MRC_UNENCUMBERED_AMOUNT,
END_ITEM_UNIT_NUMBER,
TAX_RECOVERY_OVERRIDE_FLAG,
RECOVERABLE_TAX,
NONRECOVERABLE_TAX,
RECOVERY_RATE,
OKE_CONTRACT_LINE_ID,
OKE_CONTRACT_DELIVERABLE_ID,
AMOUNT_ORDERED,
AMOUNT_DELIVERED,
AMOUNT_CANCELLED,
DISTRIBUTION_TYPE,
AMOUNT_TO_ENCUMBER,
INVOICE_ADJUSTMENT_FLAG,
DEST_CHARGE_ACCOUNT_ID,
DEST_VARIANCE_ACCOUNT_ID,
QUANTITY_FINANCED,
AMOUNT_FINANCED,
QUANTITY_RECOUPED,
AMOUNT_RECOUPED,
RETAINAGE_WITHHELD_AMOUNT,
RETAINAGE_RELEASED_AMOUNT,
WF_ITEM_KEY,
INVOICED_VAL_IN_NTFN,
TAX_ATTRIBUTE_UPDATE_CODE,
--EVENT_ID,
INTERFACE_DISTRIBUTION_REF,
LCM_FLAG,
	group_line_id,
	uda_template_id,
	draft_id,
	amount_funded,
	funded_value,
	partial_funded_flag,
	quantity_funded,
	clm_misc_loa,
	clm_defence_funding,
	clm_fms_case_number,
	clm_agency_acct_identifier,
	change_in_funded_value,
	acrn,
	revision_num,
	amount_reversed,
	clm_payment_sequence_num,
	amount_changed_flag,
	global_attribute_category,
	global_attribute1,
	global_attribute2,
	global_attribute3,
	global_attribute4,
	global_attribute5,
	global_attribute6,
	global_attribute7,
	global_attribute8,
	global_attribute9,
	global_attribute10,
	global_attribute11,
	global_attribute12,
	global_attribute13,
	global_attribute14,
	global_attribute15,
	global_attribute16,
	global_attribute17,
	global_attribute18,
	global_attribute19,
	global_attribute20,
KCA_OPERATION
,kca_seq_id
,KCA_SEQ_DATE)
(
	select
	PO_DISTRIBUTION_ID,
LAST_UPDATE_DATE,
LAST_UPDATED_BY,
PO_HEADER_ID,
PO_LINE_ID,
LINE_LOCATION_ID,
SET_OF_BOOKS_ID,
CODE_COMBINATION_ID,
QUANTITY_ORDERED,
LAST_UPDATE_LOGIN,
CREATION_DATE,
CREATED_BY,
PO_RELEASE_ID,
QUANTITY_DELIVERED,
QUANTITY_BILLED,
QUANTITY_CANCELLED,
REQ_HEADER_REFERENCE_NUM,
REQ_LINE_REFERENCE_NUM,
REQ_DISTRIBUTION_ID,
DELIVER_TO_LOCATION_ID,
DELIVER_TO_PERSON_ID,
RATE_DATE,
RATE,
AMOUNT_BILLED,
ACCRUED_FLAG,
ENCUMBERED_FLAG,
ENCUMBERED_AMOUNT,
UNENCUMBERED_QUANTITY,
UNENCUMBERED_AMOUNT,
FAILED_FUNDS_LOOKUP_CODE,
GL_ENCUMBERED_DATE,
GL_ENCUMBERED_PERIOD_NAME,
GL_CANCELLED_DATE,
DESTINATION_TYPE_CODE,
DESTINATION_ORGANIZATION_ID,
DESTINATION_SUBINVENTORY,
ATTRIBUTE_CATEGORY,
ATTRIBUTE1,
ATTRIBUTE2,
ATTRIBUTE3,
ATTRIBUTE4,
ATTRIBUTE5,
ATTRIBUTE6,
ATTRIBUTE7,
ATTRIBUTE8,
ATTRIBUTE9,
ATTRIBUTE10,
ATTRIBUTE11,
ATTRIBUTE12,
ATTRIBUTE13,
ATTRIBUTE14,
ATTRIBUTE15,
WIP_ENTITY_ID,
WIP_OPERATION_SEQ_NUM,
WIP_RESOURCE_SEQ_NUM,
WIP_REPETITIVE_SCHEDULE_ID,
WIP_LINE_ID,
BOM_RESOURCE_ID,
BUDGET_ACCOUNT_ID,
ACCRUAL_ACCOUNT_ID,
VARIANCE_ACCOUNT_ID,
PREVENT_ENCUMBRANCE_FLAG,
USSGL_TRANSACTION_CODE,
GOVERNMENT_CONTEXT,
DESTINATION_CONTEXT,
DISTRIBUTION_NUM,
SOURCE_DISTRIBUTION_ID,
REQUEST_ID,
PROGRAM_APPLICATION_ID,
PROGRAM_ID,
PROGRAM_UPDATE_DATE,
PROJECT_ID,
TASK_ID,
EXPENDITURE_TYPE,
PROJECT_ACCOUNTING_CONTEXT,
EXPENDITURE_ORGANIZATION_ID,
GL_CLOSED_DATE,
ACCRUE_ON_RECEIPT_FLAG,
EXPENDITURE_ITEM_DATE,
ORG_ID,
KANBAN_CARD_ID,
AWARD_ID,
MRC_RATE_DATE,
MRC_RATE,
MRC_ENCUMBERED_AMOUNT,
MRC_UNENCUMBERED_AMOUNT,
END_ITEM_UNIT_NUMBER,
TAX_RECOVERY_OVERRIDE_FLAG,
RECOVERABLE_TAX,
NONRECOVERABLE_TAX,
RECOVERY_RATE,
OKE_CONTRACT_LINE_ID,
OKE_CONTRACT_DELIVERABLE_ID,
AMOUNT_ORDERED,
AMOUNT_DELIVERED,
AMOUNT_CANCELLED,
DISTRIBUTION_TYPE,
AMOUNT_TO_ENCUMBER,
INVOICE_ADJUSTMENT_FLAG,
DEST_CHARGE_ACCOUNT_ID,
DEST_VARIANCE_ACCOUNT_ID,
QUANTITY_FINANCED,
AMOUNT_FINANCED,
QUANTITY_RECOUPED,
AMOUNT_RECOUPED,
RETAINAGE_WITHHELD_AMOUNT,
RETAINAGE_RELEASED_AMOUNT,
WF_ITEM_KEY,
INVOICED_VAL_IN_NTFN,
TAX_ATTRIBUTE_UPDATE_CODE,
--EVENT_ID,
INTERFACE_DISTRIBUTION_REF,
LCM_FLAG,
	group_line_id,
	uda_template_id,
	draft_id,
	amount_funded,
	funded_value,
	partial_funded_flag,
	quantity_funded,
	clm_misc_loa,
	clm_defence_funding,
	clm_fms_case_number,
	clm_agency_acct_identifier,
	change_in_funded_value,
	acrn,
	revision_num,
	amount_reversed,
	clm_payment_sequence_num,
	amount_changed_flag,
	global_attribute_category,
	global_attribute1,
	global_attribute2,
	global_attribute3,
	global_attribute4,
	global_attribute5,
	global_attribute6,
	global_attribute7,
	global_attribute8,
	global_attribute9,
	global_attribute10,
	global_attribute11,
	global_attribute12,
	global_attribute13,
	global_attribute14,
	global_attribute15,
	global_attribute16,
	global_attribute17,
	global_attribute18,
	global_attribute19,
	global_attribute20,
KCA_OPERATION
,kca_seq_id
,KCA_SEQ_DATE
	from
		bec_raw_dl_ext.po_distributions_all

where kca_operation != 'DELETE'  and nvl(kca_seq_id,'') != '' and (PO_DISTRIBUTION_ID,kca_seq_id) in (select PO_DISTRIBUTION_ID,max(kca_seq_id) 
from bec_raw_dl_ext.po_distributions_all 
where kca_operation != 'DELETE'  and nvl(kca_seq_id,'') != ''
group by PO_DISTRIBUTION_ID)
and 
(KCA_SEQ_DATE > (
select (executebegints-prune_days) from bec_etl_ctrl.batch_ods_info where ods_table_name = 'po_distributions_all')
            )
);
end;
