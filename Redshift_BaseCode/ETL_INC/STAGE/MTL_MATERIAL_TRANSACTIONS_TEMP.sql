/*
# Copyright(c) 2022 KPI Partners, Inc. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# author: KPI Partners, Inc.
# version: 2022.06
# description: This script represents Incremental load approach for stage.
# File Version: KPI v1.0
*/
begin;

truncate
	table bec_ods_stg.MTL_MATERIAL_TRANSACTIONS_TEMP;

insert
	into
	bec_ods_stg.MTL_MATERIAL_TRANSACTIONS_TEMP
    (transaction_header_id,
	transaction_temp_id,
	source_code,
	source_line_id,
	transaction_mode,
	lock_flag,
	last_update_date,
	last_updated_by,
	creation_date,
	created_by,
	last_update_login,
	request_id,
	program_application_id,
	program_id,
	program_update_date,
	inventory_item_id,
	revision,
	organization_id,
	subinventory_code,
	locator_id,
	transaction_quantity,
	primary_quantity,
	transaction_uom,
	transaction_cost,
	transaction_type_id,
	transaction_action_id,
	transaction_source_type_id,
	transaction_source_id,
	transaction_source_name,
	transaction_date,
	acct_period_id,
	distribution_account_id,
	transaction_reference,
	requisition_line_id,
	requisition_distribution_id,
	reason_id,
	lot_number,
	lot_expiration_date,
	serial_number,
	receiving_document,
	demand_id,
	rcv_transaction_id,
	move_transaction_id,
	completion_transaction_id,
	wip_entity_type,
	schedule_id,
	repetitive_line_id,
	employee_code,
	primary_switch,
	schedule_update_code,
	setup_teardown_code,
	item_ordering,
	negative_req_flag,
	operation_seq_num,
	picking_line_id,
	trx_source_line_id,
	trx_source_delivery_id,
	physical_adjustment_id,
	cycle_count_id,
	rma_line_id,
	customer_ship_id,
	currency_code,
	currency_conversion_rate,
	currency_conversion_type,
	currency_conversion_date,
	ussgl_transaction_code,
	vendor_lot_number,
	encumbrance_account,
	encumbrance_amount,
	ship_to_location,
	shipment_number,
	transfer_cost,
	transportation_cost,
	transportation_account,
	freight_code,
	containers,
	waybill_airbill,
	expected_arrival_date,
	transfer_subinventory,
	transfer_organization,
	transfer_to_location,
	new_average_cost,
	value_change,
	percentage_change,
	material_allocation_temp_id,
	demand_source_header_id,
	demand_source_line,
	demand_source_delivery,
	item_segments,
	item_description,
	item_trx_enabled_flag,
	item_location_control_code,
	item_restrict_subinv_code,
	item_restrict_locators_code,
	item_revision_qty_control_code,
	item_primary_uom_code,
	item_uom_class,
	item_shelf_life_code,
	item_shelf_life_days,
	item_lot_control_code,
	item_serial_control_code,
	item_inventory_asset_flag,
	allowed_units_lookup_code,
	department_id,
	department_code,
	wip_supply_type,
	supply_subinventory,
	supply_locator_id,
	valid_subinventory_flag,
	valid_locator_flag,
	locator_segments,
	current_locator_control_code,
	number_of_lots_entered,
	wip_commit_flag,
	next_lot_number,
	lot_alpha_prefix,
	next_serial_number,
	serial_alpha_prefix,
	shippable_flag,
	posting_flag,
	required_flag,
	process_flag,
	error_code,
	error_explanation,
	attribute_category,
	attribute1,
	attribute2,
	attribute3,
	attribute4,
	attribute5,
	attribute6,
	attribute7,
	attribute8,
	attribute9,
	attribute10,
	attribute11,
	attribute12,
	attribute13,
	attribute14,
	attribute15,
	movement_id,
	reservation_quantity,
	shipped_quantity,
	transaction_line_number,
	task_id,
	to_task_id,
	source_task_id,
	project_id,
	source_project_id,
	pa_expenditure_org_id,
	to_project_id,
	expenditure_type,
	final_completion_flag,
	transfer_percentage,
	transaction_sequence_id,
	material_account,
	material_overhead_account,
	resource_account,
	outside_processing_account,
	overhead_account,
	flow_schedule,
	cost_group_id,
	demand_class,
	qa_collection_id,
	kanban_card_id,
	overcompletion_transaction_qty,
	overcompletion_primary_qty,
	overcompletion_transaction_id,
	end_item_unit_number,
	scheduled_payback_date,
	line_type_code,
	parent_transaction_temp_id,
	put_away_strategy_id,
	put_away_rule_id,
	pick_strategy_id,
	pick_rule_id,
	move_order_line_id,
	task_group_id,
	pick_slip_number,
	reservation_id,
	common_bom_seq_id,
	common_routing_seq_id,
	org_cost_group_id,
	cost_type_id,
	transaction_status,
	standard_operation_id,
	task_priority,
	wms_task_type,
	parent_line_id,
	source_lot_number,
	transfer_cost_group_id,
	lpn_id,
	transfer_lpn_id,
	wms_task_status,
	content_lpn_id,
	container_item_id,
	cartonization_id,
	pick_slip_date,
	rebuild_item_id,
	rebuild_serial_number,
	rebuild_activity_id,
	rebuild_job_name,
	organization_type,
	transfer_organization_type,
	owning_organization_id,
	owning_tp_type,
	xfr_owning_organization_id,
	transfer_owning_tp_type,
	planning_organization_id,
	planning_tp_type,
	xfr_planning_organization_id,
	transfer_planning_tp_type,
	secondary_uom_code,
	secondary_transaction_quantity,
	allocated_lpn_id,
	schedule_number,
	scheduled_flag,
	class_code,
	schedule_group,
	build_sequence,
	bom_revision,
	routing_revision,
	bom_revision_date,
	routing_revision_date,
	alternate_bom_designator,
	alternate_routing_designator,
	transaction_batch_id,
	transaction_batch_seq,
	operation_plan_id,
	intransit_account,
	fob_point,
	move_order_header_id,
	serial_allocated_flag,
	trx_flow_header_id,
	logical_trx_type_code,
	original_transaction_temp_id,
	transfer_secondary_quantity,
	transfer_secondary_uom,
	relieve_reservations_flag,
	relieve_high_level_rsv_flag,
	transfer_price,
	material_expense_account,
	fulfillment_base,
	nested_parent_line_id,
	KCA_OPERATION,
	KCA_SEQ_ID,
	kca_seq_date)
(
	select
		transaction_header_id,
		transaction_temp_id,
		source_code,
		source_line_id,
		transaction_mode,
		lock_flag,
		last_update_date,
		last_updated_by,
		creation_date,
		created_by,
		last_update_login,
		request_id,
		program_application_id,
		program_id,
		program_update_date,
		inventory_item_id,
		revision,
		organization_id,
		subinventory_code,
		locator_id,
		transaction_quantity,
		primary_quantity,
		transaction_uom,
		transaction_cost,
		transaction_type_id,
		transaction_action_id,
		transaction_source_type_id,
		transaction_source_id,
		transaction_source_name,
		transaction_date,
		acct_period_id,
		distribution_account_id,
		transaction_reference,
		requisition_line_id,
		requisition_distribution_id,
		reason_id,
		lot_number,
		lot_expiration_date,
		serial_number,
		receiving_document,
		demand_id,
		rcv_transaction_id,
		move_transaction_id,
		completion_transaction_id,
		wip_entity_type,
		schedule_id,
		repetitive_line_id,
		employee_code,
		primary_switch,
		schedule_update_code,
		setup_teardown_code,
		item_ordering,
		negative_req_flag,
		operation_seq_num,
		picking_line_id,
		trx_source_line_id,
		trx_source_delivery_id,
		physical_adjustment_id,
		cycle_count_id,
		rma_line_id,
		customer_ship_id,
		currency_code,
		currency_conversion_rate,
		currency_conversion_type,
		currency_conversion_date,
		ussgl_transaction_code,
		vendor_lot_number,
		encumbrance_account,
		encumbrance_amount,
		ship_to_location,
		shipment_number,
		transfer_cost,
		transportation_cost,
		transportation_account,
		freight_code,
		containers,
		waybill_airbill,
		expected_arrival_date,
		transfer_subinventory,
		transfer_organization,
		transfer_to_location,
		new_average_cost,
		value_change,
		percentage_change,
		material_allocation_temp_id,
		demand_source_header_id,
		demand_source_line,
		demand_source_delivery,
		item_segments,
		item_description,
		item_trx_enabled_flag,
		item_location_control_code,
		item_restrict_subinv_code,
		item_restrict_locators_code,
		item_revision_qty_control_code,
		item_primary_uom_code,
		item_uom_class,
		item_shelf_life_code,
		item_shelf_life_days,
		item_lot_control_code,
		item_serial_control_code,
		item_inventory_asset_flag,
		allowed_units_lookup_code,
		department_id,
		department_code,
		wip_supply_type,
		supply_subinventory,
		supply_locator_id,
		valid_subinventory_flag,
		valid_locator_flag,
		locator_segments,
		current_locator_control_code,
		number_of_lots_entered,
		wip_commit_flag,
		next_lot_number,
		lot_alpha_prefix,
		next_serial_number,
		serial_alpha_prefix,
		shippable_flag,
		posting_flag,
		required_flag,
		process_flag,
		error_code,
		error_explanation,
		attribute_category,
		attribute1,
		attribute2,
		attribute3,
		attribute4,
		attribute5,
		attribute6,
		attribute7,
		attribute8,
		attribute9,
		attribute10,
		attribute11,
		attribute12,
		attribute13,
		attribute14,
		attribute15,
		movement_id,
		reservation_quantity,
		shipped_quantity,
		transaction_line_number,
		task_id,
		to_task_id,
		source_task_id,
		project_id,
		source_project_id,
		pa_expenditure_org_id,
		to_project_id,
		expenditure_type,
		final_completion_flag,
		transfer_percentage,
		transaction_sequence_id,
		material_account,
		material_overhead_account,
		resource_account,
		outside_processing_account,
		overhead_account,
		flow_schedule,
		cost_group_id,
		demand_class,
		qa_collection_id,
		kanban_card_id,
		overcompletion_transaction_qty,
		overcompletion_primary_qty,
		overcompletion_transaction_id,
		end_item_unit_number,
		scheduled_payback_date,
		line_type_code,
		parent_transaction_temp_id,
		put_away_strategy_id,
		put_away_rule_id,
		pick_strategy_id,
		pick_rule_id,
		move_order_line_id,
		task_group_id,
		pick_slip_number,
		reservation_id,
		common_bom_seq_id,
		common_routing_seq_id,
		org_cost_group_id,
		cost_type_id,
		transaction_status,
		standard_operation_id,
		task_priority,
		wms_task_type,
		parent_line_id,
		source_lot_number,
		transfer_cost_group_id,
		lpn_id,
		transfer_lpn_id,
		wms_task_status,
		content_lpn_id,
		container_item_id,
		cartonization_id,
		pick_slip_date,
		rebuild_item_id,
		rebuild_serial_number,
		rebuild_activity_id,
		rebuild_job_name,
		organization_type,
		transfer_organization_type,
		owning_organization_id,
		owning_tp_type,
		xfr_owning_organization_id,
		transfer_owning_tp_type,
		planning_organization_id,
		planning_tp_type,
		xfr_planning_organization_id,
		transfer_planning_tp_type,
		secondary_uom_code,
		secondary_transaction_quantity,
		allocated_lpn_id,
		schedule_number,
		scheduled_flag,
		class_code,
		schedule_group,
		build_sequence,
		bom_revision,
		routing_revision,
		bom_revision_date,
		routing_revision_date,
		alternate_bom_designator,
		alternate_routing_designator,
		transaction_batch_id,
		transaction_batch_seq,
		operation_plan_id,
		intransit_account,
		fob_point,
		move_order_header_id,
		serial_allocated_flag,
		trx_flow_header_id,
		logical_trx_type_code,
		original_transaction_temp_id,
		transfer_secondary_quantity,
		transfer_secondary_uom,
		relieve_reservations_flag,
		relieve_high_level_rsv_flag,
		transfer_price,
		material_expense_account,
		fulfillment_base,
		nested_parent_line_id,
		KCA_OPERATION,
		KCA_SEQ_ID,
	kca_seq_date
	from
		bec_raw_dl_ext.MTL_MATERIAL_TRANSACTIONS_TEMP
	where
		kca_operation != 'DELETE' and nvl(kca_seq_id,'')!= '' 
		and ( nvl(TRANSACTION_HEADER_ID, 0) ,
				nvl(TRANSACTION_TEMP_ID, 0) ,
		KCA_SEQ_ID) in 
	(
		select
			nvl(TRANSACTION_HEADER_ID, 0) as TRANSACTION_HEADER_ID,
			nvl(TRANSACTION_TEMP_ID, 0) as TRANSACTION_TEMP_ID,
			max(KCA_SEQ_ID)
		from
			bec_raw_dl_ext.MTL_MATERIAL_TRANSACTIONS_TEMP
		where
			kca_operation != 'DELETE' and nvl(kca_seq_id,'')!= '' 
		group by
			nvl(TRANSACTION_HEADER_ID, 0) ,
				nvl(TRANSACTION_TEMP_ID, 0) )
		and ( kca_seq_date > (
		select
			(executebegints-prune_days)
		from
			bec_etl_ctrl.batch_ods_info
		where
			ods_table_name = 'mtl_material_transactions_temp')
			 
            )
			);
end;