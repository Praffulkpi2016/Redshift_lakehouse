/*
# Copyright(c) 2022 KPI Partners, Inc. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# author: KPI Partners, Inc.
# version: 2022.06
# description: This script represents incremental load approach for Facts.
# File Version: KPI v1.0
*/
begin;
--truncate temp table
TRUNCATE TABLE bec_dwh.FACT_INTRANSIT_VALUE_TMP ;
--Insert incremental data into temp table.
INSERT INTO bec_dwh.FACT_INTRANSIT_VALUE_TMP
(
select distinct ms.SUPPLY_SOURCE_ID,ITEM_ID,INTRANSIT_OWNING_ORG_ID
FROM
BEC_ODS.MTL_SUPPLY MS,
BEC_ODS.CST_ITEM_COSTS CIC,
BEC_ODS.RCV_SERIALS_SUPPLY SER,
BEC_ODS.RCV_LOTS_SUPPLY LOT,
BEC_ODS.RCV_SHIPMENT_HEADERS RSH,
BEC_ODS.ORG_ORGANIZATION_DEFINITIONS OOD1,
BEC_ODS.ORG_ORGANIZATION_DEFINITIONS OOD2
WHERE
1 = 1
AND MS.SUPPLY_TYPE_CODE IN ('SHIPMENT', 'RECEIVING')
AND MS.DESTINATION_TYPE_CODE = 'INVENTORY'
AND MS.ITEM_ID = CIC.INVENTORY_ITEM_ID
AND MS.INTRANSIT_OWNING_ORG_ID = CIC.ORGANIZATION_ID
AND CIC.COST_TYPE_ID = 1
AND MS.SHIPMENT_LINE_ID = SER.SHIPMENT_LINE_ID(+)
AND MS.SHIPMENT_LINE_ID = LOT.SHIPMENT_LINE_ID(+)
AND MS.SHIPMENT_HEADER_ID = RSH.SHIPMENT_HEADER_ID(+)
AND MS.TO_ORGANIZATION_ID = OOD1.ORGANIZATION_ID(+)
AND MS.FROM_ORGANIZATION_ID = OOD2.ORGANIZATION_ID(+)
and (MS.kca_seq_date > (
			select
				(executebegints-prune_days)
			from
				bec_etl_ctrl.batch_dw_info
			where
				dw_table_name = 'fact_intransit_value'
				and batch_name = 'om')
	or 
	SER.kca_seq_date > (
			select
				(executebegints-prune_days)
			from
				bec_etl_ctrl.batch_dw_info
			where
				dw_table_name = 'fact_intransit_value'
				and batch_name = 'om')
	OR
	LOT.kca_seq_date > (
			select
				(executebegints-prune_days)
			from
				bec_etl_ctrl.batch_dw_info
			where
				dw_table_name = 'fact_intransit_value'
				and batch_name = 'om')
	OR
	CIC.kca_seq_date > (
			select
				(executebegints-prune_days)
			from
				bec_etl_ctrl.batch_dw_info
			where
				dw_table_name = 'fact_intransit_value'
				and batch_name = 'om')				
	) 
);
--DELETE FROM FACT TABLE USING TMP TABLE
delete from bec_dwh.FACT_INTRANSIT_VALUE
where (SUPPLY_SOURCE_ID,ITEM_ID,OWNING_ORGANIZATION_ID) 
IN (select SUPPLY_SOURCE_ID,ITEM_ID,OWNING_ORGANIZATION_ID 
    from bec_dwh.FACT_INTRANSIT_VALUE_TMP);
--INSERT INTO FACT TABLE
INSERT INTO bec_dwh.FACT_INTRANSIT_VALUE
(
SELECT
    MS.ITEM_ID,
	MS.INTRANSIT_OWNING_ORG_ID OWNING_ORGANIZATION_ID,
	RSH.SHIPMENT_NUM,
	MS.MRP_PRIMARY_QUANTITY,
	SER.SERIAL_NUM,
	LOT.LOT_NUM,
	DECODE (SER.SERIAL_NUM,	NULL,NVL (LOT.PRIMARY_QUANTITY,	MS.MRP_PRIMARY_QUANTITY),1) SET_LOT_QTY,
	CIC.ITEM_COST,
	DECODE (SER.SERIAL_NUM, NULL,NVL (LOT.PRIMARY_QUANTITY,	MS.MRP_PRIMARY_QUANTITY),1) * CIC.ITEM_COST EXTENDED_COST,
	MS.SUPPLY_TYPE_CODE,
	MS.SUPPLY_SOURCE_ID,
	MS.REQ_HEADER_ID,
	MS.REQ_LINE_ID,
	MS.SHIPMENT_HEADER_ID,
	MS.SHIPMENT_LINE_ID,
	MS.UNIT_OF_MEASURE,
	MS.RECEIPT_DATE,
	MS.NEED_BY_DATE,
	MS.EXPECTED_DELIVERY_DATE,
	MS.DESTINATION_TYPE_CODE,
	MS.FROM_ORGANIZATION_ID,
	MS.TO_ORGANIZATION_ID,
	MS.MRP_DESTINATION_TYPE_CODE,
	RSH.SHIPPED_DATE,
	OOD1.ORGANIZATION_CODE TO_ORG_CODE,
	OOD2.ORGANIZATION_CODE FROM_ORG_CODE,
	MS.FROM_SUBINVENTORY,
	MS.TO_SUBINVENTORY,
		-- audit columns
	'N' AS IS_DELETED_FLG,
	(
	SELECT
		SYSTEM_ID
	FROM
		BEC_ETL_CTRL.ETLSOURCEAPPID
	WHERE
		SOURCE_SYSTEM = 'EBS') AS SOURCE_APP_ID,
	(
	SELECT
		SYSTEM_ID
	FROM
		BEC_ETL_CTRL.ETLSOURCEAPPID
	WHERE
		SOURCE_SYSTEM = 'EBS')
		|| '-' || NVL(MS.SUPPLY_SOURCE_ID, 0)
		|| '-' || NVL(MS.SUPPLY_TYPE_CODE,'NA')
		|| '-' || NVL(SER.SERIAL_NUM,'NA')
		|| '-' || NVL(LOT.LOT_NUM,'NA') AS DW_LOAD_ID,
	GETDATE() AS DW_INSERT_DATE,
	GETDATE() AS DW_UPDATE_DATE
FROM
	(SELECT * FROM BEC_ODS.MTL_SUPPLY WHERE IS_DELETED_FLG <> 'Y') MS,
	(SELECT * FROM BEC_ODS.CST_ITEM_COSTS WHERE IS_DELETED_FLG <> 'Y') CIC,
	(SELECT * FROM BEC_ODS.RCV_SERIALS_SUPPLY WHERE IS_DELETED_FLG <> 'Y') SER,
	(SELECT * FROM BEC_ODS.RCV_LOTS_SUPPLY WHERE IS_DELETED_FLG <> 'Y') LOT,
	(SELECT * FROM BEC_ODS.RCV_SHIPMENT_HEADERS WHERE IS_DELETED_FLG <> 'Y') RSH,
	(SELECT * FROM BEC_ODS.ORG_ORGANIZATION_DEFINITIONS WHERE IS_DELETED_FLG <> 'Y') OOD1,
	(SELECT * FROM BEC_ODS.ORG_ORGANIZATION_DEFINITIONS WHERE IS_DELETED_FLG <> 'Y') OOD2,
	bec_dwh.FACT_INTRANSIT_VALUE_TMP tmp
WHERE
	1 = 1
	AND MS.SUPPLY_TYPE_CODE IN ('SHIPMENT', 'RECEIVING')
	AND MS.DESTINATION_TYPE_CODE = 'INVENTORY'
	AND MS.ITEM_ID = CIC.INVENTORY_ITEM_ID
	AND MS.INTRANSIT_OWNING_ORG_ID = CIC.ORGANIZATION_ID
	AND CIC.COST_TYPE_ID = 1
	AND MS.SHIPMENT_LINE_ID = SER.SHIPMENT_LINE_ID(+)
	AND MS.SHIPMENT_LINE_ID = LOT.SHIPMENT_LINE_ID(+)
	AND MS.SHIPMENT_HEADER_ID = RSH.SHIPMENT_HEADER_ID(+)
	AND MS.TO_ORGANIZATION_ID = OOD1.ORGANIZATION_ID(+)
	AND MS.FROM_ORGANIZATION_ID = OOD2.ORGANIZATION_ID(+)
	AND MS.SUPPLY_SOURCE_ID= tmp.SUPPLY_SOURCE_ID
	AND MS.item_id = tmp.item_id 
	AND MS.INTRANSIT_OWNING_ORG_ID = tmp.OWNING_ORGANIZATION_ID
);
end;

update
	bec_etl_ctrl.batch_dw_info
set
	load_type = 'I',
	last_refresh_date = getdate()
where
	dw_table_name = 'fact_intransit_value'
	and batch_name = 'om';

commit;