/*
# Copyright(c) 2022 KPI Partners, Inc. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# author: KPI Partners, Inc.
# version: 2022.06
# description: This script represents Incremental load approach for ODS.
# File Version: KPI v1.0
*/
begin;

-- Delete Records

delete from bec_ods.pa_expenditure_items_all
where (nvl(EXPENDITURE_ITEM_ID,0)) in (
select nvl(stg.EXPENDITURE_ITEM_ID,0) as EXPENDITURE_ITEM_ID from bec_ods.pa_expenditure_items_all ods, bec_ods_stg.pa_expenditure_items_all stg
where nvl(ods.EXPENDITURE_ITEM_ID,0) = nvl(stg.EXPENDITURE_ITEM_ID,0) and stg.kca_operation IN ('INSERT','UPDATE')
);

commit;

-- Insert records

insert into	bec_ods.pa_expenditure_items_all
       (	
		EXPENDITURE_ITEM_ID,
		LAST_UPDATE_DATE,
		LAST_UPDATED_BY,
		CREATION_DATE,
		CREATED_BY,
		EXPENDITURE_ID,
		TASK_ID,
		EXPENDITURE_ITEM_DATE,
		EXPENDITURE_TYPE,
		COST_DISTRIBUTED_FLAG,
		REVENUE_DISTRIBUTED_FLAG,
		BILLABLE_FLAG,
		BILL_HOLD_FLAG,
		QUANTITY,
		NON_LABOR_RESOURCE,
		ORGANIZATION_ID,
		OVERRIDE_TO_ORGANIZATION_ID,
		RAW_COST,
		RAW_COST_RATE,
		BURDEN_COST,
		BURDEN_COST_RATE,
		COST_DIST_REJECTION_CODE,
		LABOR_COST_MULTIPLIER_NAME,
		RAW_REVENUE,
		BILL_RATE,
		ACCRUED_REVENUE,
		ACCRUAL_RATE,
		ADJUSTED_REVENUE,
		ADJUSTED_RATE,
		BILL_AMOUNT,
		FORECAST_REVENUE,
		BILL_RATE_MULTIPLIER,
		REV_DIST_REJECTION_CODE,
		EVENT_NUM,
		EVENT_TASK_ID,
		BILL_JOB_ID,
		BILL_JOB_BILLING_TITLE,
		BILL_EMPLOYEE_BILLING_TITLE,
		ADJUSTED_EXPENDITURE_ITEM_ID,
		NET_ZERO_ADJUSTMENT_FLAG,
		TRANSFERRED_FROM_EXP_ITEM_ID,
		CONVERTED_FLAG,
		LAST_UPDATE_LOGIN,
		REQUEST_ID,
		PROGRAM_APPLICATION_ID,
		PROGRAM_ID,
		PROGRAM_UPDATE_DATE,
		ATTRIBUTE_CATEGORY,
		ATTRIBUTE1,
		ATTRIBUTE2,
		ATTRIBUTE3,
		ATTRIBUTE4,
		ATTRIBUTE5,
		ATTRIBUTE6,
		ATTRIBUTE7,
		ATTRIBUTE8,
		ATTRIBUTE9,
		ATTRIBUTE10,
		COST_IND_COMPILED_SET_ID,
		REV_IND_COMPILED_SET_ID,
		INV_IND_COMPILED_SET_ID,
		COST_BURDEN_DISTRIBUTED_FLAG,
		IND_COST_DIST_REJECTION_CODE,
		ORIG_TRANSACTION_REFERENCE,
		TRANSACTION_SOURCE,
		PROJECT_ID,
		SOURCE_EXPENDITURE_ITEM_ID,
		JOB_ID,
		ORG_ID,
		SYSTEM_LINKAGE_FUNCTION,
		BURDEN_SUM_DEST_RUN_ID,
		RECEIPT_CURRENCY_AMOUNT,
		RECEIPT_CURRENCY_CODE,
		RECEIPT_EXCHANGE_RATE,
		DENOM_CURRENCY_CODE,
		DENOM_RAW_COST,
		DENOM_BURDENED_COST,
		ACCT_CURRENCY_CODE,
		ACCT_RATE_DATE,
		ACCT_RATE_TYPE,
		ACCT_EXCHANGE_RATE,
		ACCT_RAW_COST,
		ACCT_BURDENED_COST,
		ACCT_EXCHANGE_ROUNDING_LIMIT,
		PROJECT_CURRENCY_CODE,
		PROJECT_RATE_DATE,
		PROJECT_RATE_TYPE,
		PROJECT_EXCHANGE_RATE,
		DENORM_ID,
		CC_CROSS_CHARGE_CODE,
		CC_PRVDR_ORGANIZATION_ID,
		CC_RECVR_ORGANIZATION_ID,
		CC_REJECTION_CODE,
		DENOM_TP_CURRENCY_CODE,
		DENOM_TRANSFER_PRICE,
		ACCT_TP_RATE_TYPE,
		ACCT_TP_RATE_DATE,
		ACCT_TP_EXCHANGE_RATE,
		ACCT_TRANSFER_PRICE,
		PROJACCT_TRANSFER_PRICE,
		CC_MARKUP_BASE_CODE,
		TP_BASE_AMOUNT,
		CC_CROSS_CHARGE_TYPE,
		RECVR_ORG_ID,
		CC_BL_DISTRIBUTED_CODE,
		CC_IC_PROCESSED_CODE,
		TP_IND_COMPILED_SET_ID,
		TP_BILL_RATE,
		TP_BILL_MARKUP_PERCENTAGE,
		TP_SCHEDULE_LINE_PERCENTAGE,
		TP_RULE_PERCENTAGE,
		CC_PRVDR_COST_RECLASS_CODE,
		CRL_ASSET_CREATION_STATUS_CODE,
		CRL_ASSET_CREATION_REJ_CODE,
		COST_JOB_ID,
		TP_JOB_ID,
		PROV_PROJ_BILL_JOB_ID,
		COST_DIST_WARNING_CODE,
		PROJECT_TP_RATE_DATE,
		PROJECT_TP_RATE_TYPE,
		PROJECT_TP_EXCHANGE_RATE,
		PROJFUNC_TP_RATE_DATE,
		PROJFUNC_TP_RATE_TYPE,
		PROJFUNC_TP_EXCHANGE_RATE,
		PROJFUNC_TRANSFER_PRICE,
		BILL_TRANS_FORECAST_CURR_CODE,
		BILL_TRANS_FORECAST_REVENUE,
		PROJFUNC_REV_RATE_DATE,
		PROJFUNC_REV_EXCHANGE_RATE,
		PROJFUNC_COST_RATE_TYPE,
		PROJFUNC_COST_RATE_DATE,
		PROJFUNC_COST_EXCHANGE_RATE,
		PROJECT_RAW_COST,
		PROJECT_BURDENED_COST,
		ASSIGNMENT_ID,
		WORK_TYPE_ID,
		PROJFUNC_RAW_REVENUE,
		PROJECT_BILL_AMOUNT,
		PROJFUNC_CURRENCY_CODE,
		PROJECT_RAW_REVENUE,
		PROJECT_TRANSFER_PRICE,
		TP_AMT_TYPE_CODE,
		BILL_TRANS_CURRENCY_CODE,
		BILL_TRANS_RAW_REVENUE,
		BILL_TRANS_BILL_AMOUNT,
		BILL_TRANS_ADJUSTED_REVENUE,
		REVPROC_CURRENCY_CODE,
		REVPROC_RATE_TYPE,
		REVPROC_RATE_DATE,
		REVPROC_EXCHANGE_RATE,
		INVPROC_CURRENCY_CODE,
		INVPROC_RATE_TYPE,
		INVPROC_RATE_DATE,
		DISCOUNT_PERCENTAGE,
		LABOR_MULTIPLIER,
		AMOUNT_CALCULATION_CODE,
		BILL_MARKUP_PERCENTAGE,
		RATE_SOURCE_ID,
		INVPROC_EXCHANGE_RATE,
		INV_GEN_REJECTION_CODE,
		PROJFUNC_BILL_AMOUNT,
		PROJECT_REV_RATE_TYPE,
		PROJECT_REV_RATE_DATE,
		PROJECT_REV_EXCHANGE_RATE,
		PROJFUNC_REV_RATE_TYPE,
		PROJFUNC_INV_RATE_TYPE,
		PROJFUNC_INV_RATE_DATE,
		PROJFUNC_INV_EXCHANGE_RATE,
		PROJECT_INV_RATE_TYPE,
		PROJECT_INV_RATE_DATE,
		PROJECT_INV_EXCHANGE_RATE,
		PROJFUNC_FCST_RATE_TYPE,
		PROJFUNC_FCST_RATE_DATE,
		PROJFUNC_FCST_EXCHANGE_RATE,
		PRVDR_ACCRUAL_DATE,
		RECVR_ACCRUAL_DATE,
		RATE_DISC_REASON_CODE,
		POSTED_DENOM_BURDENED_COST,
		POSTED_PROJECT_BURDENED_COST,
		POSTED_PROJFUNC_BURDENED_COST,
		POSTED_ACCT_BURDENED_COST,
		ADJUSTMENT_TYPE,
		CAPITAL_EVENT_ID,
		PO_LINE_ID,
		PO_PRICE_TYPE,
		WIP_RESOURCE_ID,
		INVENTORY_ITEM_ID,
		UNIT_OF_MEASURE,
		SRC_SYSTEM_LINKAGE_FUNCTION,
		DOCUMENT_HEADER_ID,
		DOCUMENT_DISTRIBUTION_ID,
		DOCUMENT_LINE_NUMBER,
		DOCUMENT_PAYMENT_ID,
		VENDOR_ID,
		DOCUMENT_TYPE,
		DOCUMENT_DISTRIBUTION_TYPE,
		HISTORICAL_FLAG,
		LOCATION_ID,
		PAY_ELEMENT_TYPE_ID,
		COSTING_METHOD,
		RATE_SOURCE_CODE,
		PAYROLL_ACCRUAL_FLAG,
		RBC_ELEMENT_TYPE_ID,
		INTERFACE_RUN_ID,
		CBS_ELEMENT_ID,
		ADD_INV_GROUP,
		BILL_GROUP,
		LEGAL_ENTITY_ID,
		RECEIVER_LEGAL_ENTITY_ID,
		REVENUE_HOLD_FLAG,
		FCB_PROCESS_FLAG,
        KCA_OPERATION,
        IS_DELETED_FLG,
		kca_seq_id
		,kca_seq_date)	
(
	select
		EXPENDITURE_ITEM_ID,
		LAST_UPDATE_DATE,
		LAST_UPDATED_BY,
		CREATION_DATE,
		CREATED_BY,
		EXPENDITURE_ID,
		TASK_ID,
		EXPENDITURE_ITEM_DATE,
		EXPENDITURE_TYPE,
		COST_DISTRIBUTED_FLAG,
		REVENUE_DISTRIBUTED_FLAG,
		BILLABLE_FLAG,
		BILL_HOLD_FLAG,
		QUANTITY,
		NON_LABOR_RESOURCE,
		ORGANIZATION_ID,
		OVERRIDE_TO_ORGANIZATION_ID,
		RAW_COST,
		RAW_COST_RATE,
		BURDEN_COST,
		BURDEN_COST_RATE,
		COST_DIST_REJECTION_CODE,
		LABOR_COST_MULTIPLIER_NAME,
		RAW_REVENUE,
		BILL_RATE,
		ACCRUED_REVENUE,
		ACCRUAL_RATE,
		ADJUSTED_REVENUE,
		ADJUSTED_RATE,
		BILL_AMOUNT,
		FORECAST_REVENUE,
		BILL_RATE_MULTIPLIER,
		REV_DIST_REJECTION_CODE,
		EVENT_NUM,
		EVENT_TASK_ID,
		BILL_JOB_ID,
		BILL_JOB_BILLING_TITLE,
		BILL_EMPLOYEE_BILLING_TITLE,
		ADJUSTED_EXPENDITURE_ITEM_ID,
		NET_ZERO_ADJUSTMENT_FLAG,
		TRANSFERRED_FROM_EXP_ITEM_ID,
		CONVERTED_FLAG,
		LAST_UPDATE_LOGIN,
		REQUEST_ID,
		PROGRAM_APPLICATION_ID,
		PROGRAM_ID,
		PROGRAM_UPDATE_DATE,
		ATTRIBUTE_CATEGORY,
		ATTRIBUTE1,
		ATTRIBUTE2,
		ATTRIBUTE3,
		ATTRIBUTE4,
		ATTRIBUTE5,
		ATTRIBUTE6,
		ATTRIBUTE7,
		ATTRIBUTE8,
		ATTRIBUTE9,
		ATTRIBUTE10,
		COST_IND_COMPILED_SET_ID,
		REV_IND_COMPILED_SET_ID,
		INV_IND_COMPILED_SET_ID,
		COST_BURDEN_DISTRIBUTED_FLAG,
		IND_COST_DIST_REJECTION_CODE,
		ORIG_TRANSACTION_REFERENCE,
		TRANSACTION_SOURCE,
		PROJECT_ID,
		SOURCE_EXPENDITURE_ITEM_ID,
		JOB_ID,
		ORG_ID,
		SYSTEM_LINKAGE_FUNCTION,
		BURDEN_SUM_DEST_RUN_ID,
		RECEIPT_CURRENCY_AMOUNT,
		RECEIPT_CURRENCY_CODE,
		RECEIPT_EXCHANGE_RATE,
		DENOM_CURRENCY_CODE,
		DENOM_RAW_COST,
		DENOM_BURDENED_COST,
		ACCT_CURRENCY_CODE,
		ACCT_RATE_DATE,
		ACCT_RATE_TYPE,
		ACCT_EXCHANGE_RATE,
		ACCT_RAW_COST,
		ACCT_BURDENED_COST,
		ACCT_EXCHANGE_ROUNDING_LIMIT,
		PROJECT_CURRENCY_CODE,
		PROJECT_RATE_DATE,
		PROJECT_RATE_TYPE,
		PROJECT_EXCHANGE_RATE,
		DENORM_ID,
		CC_CROSS_CHARGE_CODE,
		CC_PRVDR_ORGANIZATION_ID,
		CC_RECVR_ORGANIZATION_ID,
		CC_REJECTION_CODE,
		DENOM_TP_CURRENCY_CODE,
		DENOM_TRANSFER_PRICE,
		ACCT_TP_RATE_TYPE,
		ACCT_TP_RATE_DATE,
		ACCT_TP_EXCHANGE_RATE,
		ACCT_TRANSFER_PRICE,
		PROJACCT_TRANSFER_PRICE,
		CC_MARKUP_BASE_CODE,
		TP_BASE_AMOUNT,
		CC_CROSS_CHARGE_TYPE,
		RECVR_ORG_ID,
		CC_BL_DISTRIBUTED_CODE,
		CC_IC_PROCESSED_CODE,
		TP_IND_COMPILED_SET_ID,
		TP_BILL_RATE,
		TP_BILL_MARKUP_PERCENTAGE,
		TP_SCHEDULE_LINE_PERCENTAGE,
		TP_RULE_PERCENTAGE,
		CC_PRVDR_COST_RECLASS_CODE,
		CRL_ASSET_CREATION_STATUS_CODE,
		CRL_ASSET_CREATION_REJ_CODE,
		COST_JOB_ID,
		TP_JOB_ID,
		PROV_PROJ_BILL_JOB_ID,
		COST_DIST_WARNING_CODE,
		PROJECT_TP_RATE_DATE,
		PROJECT_TP_RATE_TYPE,
		PROJECT_TP_EXCHANGE_RATE,
		PROJFUNC_TP_RATE_DATE,
		PROJFUNC_TP_RATE_TYPE,
		PROJFUNC_TP_EXCHANGE_RATE,
		PROJFUNC_TRANSFER_PRICE,
		BILL_TRANS_FORECAST_CURR_CODE,
		BILL_TRANS_FORECAST_REVENUE,
		PROJFUNC_REV_RATE_DATE,
		PROJFUNC_REV_EXCHANGE_RATE,
		PROJFUNC_COST_RATE_TYPE,
		PROJFUNC_COST_RATE_DATE,
		PROJFUNC_COST_EXCHANGE_RATE,
		PROJECT_RAW_COST,
		PROJECT_BURDENED_COST,
		ASSIGNMENT_ID,
		WORK_TYPE_ID,
		PROJFUNC_RAW_REVENUE,
		PROJECT_BILL_AMOUNT,
		PROJFUNC_CURRENCY_CODE,
		PROJECT_RAW_REVENUE,
		PROJECT_TRANSFER_PRICE,
		TP_AMT_TYPE_CODE,
		BILL_TRANS_CURRENCY_CODE,
		BILL_TRANS_RAW_REVENUE,
		BILL_TRANS_BILL_AMOUNT,
		BILL_TRANS_ADJUSTED_REVENUE,
		REVPROC_CURRENCY_CODE,
		REVPROC_RATE_TYPE,
		REVPROC_RATE_DATE,
		REVPROC_EXCHANGE_RATE,
		INVPROC_CURRENCY_CODE,
		INVPROC_RATE_TYPE,
		INVPROC_RATE_DATE,
		DISCOUNT_PERCENTAGE,
		LABOR_MULTIPLIER,
		AMOUNT_CALCULATION_CODE,
		BILL_MARKUP_PERCENTAGE,
		RATE_SOURCE_ID,
		INVPROC_EXCHANGE_RATE,
		INV_GEN_REJECTION_CODE,
		PROJFUNC_BILL_AMOUNT,
		PROJECT_REV_RATE_TYPE,
		PROJECT_REV_RATE_DATE,
		PROJECT_REV_EXCHANGE_RATE,
		PROJFUNC_REV_RATE_TYPE,
		PROJFUNC_INV_RATE_TYPE,
		PROJFUNC_INV_RATE_DATE,
		PROJFUNC_INV_EXCHANGE_RATE,
		PROJECT_INV_RATE_TYPE,
		PROJECT_INV_RATE_DATE,
		PROJECT_INV_EXCHANGE_RATE,
		PROJFUNC_FCST_RATE_TYPE,
		PROJFUNC_FCST_RATE_DATE,
		PROJFUNC_FCST_EXCHANGE_RATE,
		PRVDR_ACCRUAL_DATE,
		RECVR_ACCRUAL_DATE,
		RATE_DISC_REASON_CODE,
		POSTED_DENOM_BURDENED_COST,
		POSTED_PROJECT_BURDENED_COST,
		POSTED_PROJFUNC_BURDENED_COST,
		POSTED_ACCT_BURDENED_COST,
		ADJUSTMENT_TYPE,
		CAPITAL_EVENT_ID,
		PO_LINE_ID,
		PO_PRICE_TYPE,
		WIP_RESOURCE_ID,
		INVENTORY_ITEM_ID,
		UNIT_OF_MEASURE,
		SRC_SYSTEM_LINKAGE_FUNCTION,
		DOCUMENT_HEADER_ID,
		DOCUMENT_DISTRIBUTION_ID,
		DOCUMENT_LINE_NUMBER,
		DOCUMENT_PAYMENT_ID,
		VENDOR_ID,
		DOCUMENT_TYPE,
		DOCUMENT_DISTRIBUTION_TYPE,
		HISTORICAL_FLAG,
		LOCATION_ID,
		PAY_ELEMENT_TYPE_ID,
		COSTING_METHOD,
		RATE_SOURCE_CODE,
		PAYROLL_ACCRUAL_FLAG,
		RBC_ELEMENT_TYPE_ID,
		INTERFACE_RUN_ID,
		CBS_ELEMENT_ID,
		ADD_INV_GROUP,
		BILL_GROUP,
		LEGAL_ENTITY_ID,
		RECEIVER_LEGAL_ENTITY_ID,
		REVENUE_HOLD_FLAG,
		FCB_PROCESS_FLAG,
        KCA_OPERATION,
       'N' AS IS_DELETED_FLG,
	    cast(NULLIF(KCA_SEQ_ID,'') as numeric(36,0)) as KCA_SEQ_ID
		,kca_seq_date
	from bec_ods_stg.pa_expenditure_items_all
	where kca_operation IN ('INSERT','UPDATE') 
	and (nvl(EXPENDITURE_ITEM_ID,0),kca_seq_id) in 
	(select nvl(EXPENDITURE_ITEM_ID,0) as EXPENDITURE_ITEM_ID,max(kca_seq_id) from bec_ods_stg.pa_expenditure_items_all 
     where kca_operation IN ('INSERT','UPDATE')
     group by nvl(EXPENDITURE_ITEM_ID,0))
);

commit;

-- Soft delete
update bec_ods.pa_expenditure_items_all set IS_DELETED_FLG = 'N';
commit;
update bec_ods.pa_expenditure_items_all set IS_DELETED_FLG = 'Y'
where (EXPENDITURE_ITEM_ID)  in
(
select EXPENDITURE_ITEM_ID from bec_raw_dl_ext.pa_expenditure_items_all
where (EXPENDITURE_ITEM_ID,KCA_SEQ_ID)
in 
(
select EXPENDITURE_ITEM_ID,max(KCA_SEQ_ID) as KCA_SEQ_ID 
from bec_raw_dl_ext.pa_expenditure_items_all
group by EXPENDITURE_ITEM_ID
) 
and kca_operation= 'DELETE'
);
commit;

end;

update bec_etl_ctrl.batch_ods_info
set	last_refresh_date = getdate()
where ods_table_name = 'pa_expenditure_items_all';

commit;