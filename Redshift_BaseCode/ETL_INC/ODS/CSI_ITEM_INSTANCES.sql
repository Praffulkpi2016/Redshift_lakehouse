/*
# Copyright(c) 2022 KPI Partners, Inc. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# author: KPI Partners, Inc.
# version: 2022.06
# description: This script represents Incremental load approach for ODS.
# File Version: KPI v1.0
*/
begin;

-- Delete Records

delete from bec_ods.csi_item_instances
where (nvl(INSTANCE_ID,0)) in (
select nvl(stg.INSTANCE_ID,0) as INSTANCE_ID from bec_ods.csi_item_instances ods, bec_ods_stg.csi_item_instances stg
where nvl(ods.INSTANCE_ID,0) = nvl(stg.INSTANCE_ID,0) and stg.kca_operation IN ('INSERT','UPDATE')
);

commit;

-- Insert records

insert into	bec_ods.csi_item_instances
       (	
		INSTANCE_ID,
		INSTANCE_NUMBER,
		EXTERNAL_REFERENCE,
		INVENTORY_ITEM_ID,
		INVENTORY_REVISION,
		INV_MASTER_ORGANIZATION_ID,
		SERIAL_NUMBER,
		MFG_SERIAL_NUMBER_FLAG,
		LOT_NUMBER,
		QUANTITY,
		UNIT_OF_MEASURE,
		ACCOUNTING_CLASS_CODE,
		INSTANCE_CONDITION_ID,
		INSTANCE_STATUS_ID,
		CUSTOMER_VIEW_FLAG,
		MERCHANT_VIEW_FLAG,
		SELLABLE_FLAG,
		SYSTEM_ID,
		INSTANCE_TYPE_CODE,
		ACTIVE_START_DATE,
		ACTIVE_END_DATE,
		LOCATION_TYPE_CODE,
		LOCATION_ID,
		INV_ORGANIZATION_ID,
		INV_SUBINVENTORY_NAME,
		INV_LOCATOR_ID,
		PA_PROJECT_ID,
		PA_PROJECT_TASK_ID,
		IN_TRANSIT_ORDER_LINE_ID,
		WIP_JOB_ID,
		PO_ORDER_LINE_ID,
		LAST_OE_ORDER_LINE_ID,
		LAST_OE_RMA_LINE_ID,
		LAST_PO_PO_LINE_ID,
		LAST_OE_PO_NUMBER,
		LAST_WIP_JOB_ID,
		LAST_PA_PROJECT_ID,
		LAST_PA_TASK_ID,
		LAST_OE_AGREEMENT_ID,
		INSTALL_DATE,
		MANUALLY_CREATED_FLAG,
		RETURN_BY_DATE,
		ACTUAL_RETURN_DATE,
		CREATION_COMPLETE_FLAG,
		COMPLETENESS_FLAG,
		CONTEXT,
		ATTRIBUTE1,
		ATTRIBUTE2,
		ATTRIBUTE3,
		ATTRIBUTE4,
		ATTRIBUTE5,
		ATTRIBUTE6,
		ATTRIBUTE7,
		ATTRIBUTE8,
		ATTRIBUTE9,
		ATTRIBUTE10,
		ATTRIBUTE11,
		ATTRIBUTE12,
		ATTRIBUTE13,
		ATTRIBUTE14,
		ATTRIBUTE15,
		CREATED_BY,
		CREATION_DATE,
		LAST_UPDATED_BY,
		LAST_UPDATE_DATE,
		LAST_UPDATE_LOGIN,
		OBJECT_VERSION_NUMBER,
		SECURITY_GROUP_ID,
		LAST_TXN_LINE_DETAIL_ID,
		INSTALL_LOCATION_TYPE_CODE,
		INSTALL_LOCATION_ID,
		INSTANCE_USAGE_CODE,
		OWNER_PARTY_SOURCE_TABLE,
		OWNER_PARTY_ID,
		OWNER_PARTY_ACCOUNT_ID,
		LAST_VLD_ORGANIZATION_ID,
		MIGRATED_FLAG,
		REQUEST_ID,
		PROGRAM_APPLICATION_ID,
		PROGRAM_ID,
		PROGRAM_UPDATE_DATE,
		CONFIG_INST_HDR_ID,
		CONFIG_INST_REV_NUM,
		CONFIG_INST_ITEM_ID,
		CONFIG_VALID_STATUS,
		INSTANCE_DESCRIPTION,
		LAST_PURGE_DATE,
		ATTRIBUTE16,
		ATTRIBUTE17,
		ATTRIBUTE18,
		ATTRIBUTE19,
		ATTRIBUTE20,
		ATTRIBUTE21,
		ATTRIBUTE22,
		ATTRIBUTE23,
		ATTRIBUTE24,
		ATTRIBUTE25,
		ATTRIBUTE26,
		ATTRIBUTE27,
		ATTRIBUTE28,
		ATTRIBUTE29,
		ATTRIBUTE30,
		NETWORK_ASSET_FLAG,
		MAINTAINABLE_FLAG,
		PN_LOCATION_ID,
		ASSET_CRITICALITY_CODE,
		CATEGORY_ID,
		EQUIPMENT_GEN_OBJECT_ID,
		INSTANTIATION_FLAG,
		LINEAR_LOCATION_ID,
		OPERATIONAL_LOG_FLAG,
		CHECKIN_STATUS,
		SUPPLIER_WARRANTY_EXP_DATE,
		PURCHASE_UNIT_PRICE,
		PURCHASE_CURRENCY_CODE,
		PAYABLES_UNIT_PRICE,
		PAYABLES_CURRENCY_CODE,
		SALES_UNIT_PRICE,
		SALES_CURRENCY_CODE,
		OPERATIONAL_STATUS_CODE,
		SOURCE_CODE,
		ROUTE_UPDATE_WO_FLAG,
		COST_UPDATE_WO_FLAG,
		ROUTE_COST_EQUAL_FLAG,
		LINEAR_ASSET,
		SEGMENTED,
		ROUTE_QUALITY_RESULT_FLAG,
		ESRI_FEATURE,
		NO_MEASURES_LA,
		ROUTE_LAYER_ID,
		IN_SERVICE_DATE,
		IOT_SYNC_DATE,
        KCA_OPERATION,
        IS_DELETED_FLG,
		kca_seq_id,
		kca_seq_date)	
(
	select
		INSTANCE_ID,
		INSTANCE_NUMBER,
		EXTERNAL_REFERENCE,
		INVENTORY_ITEM_ID,
		INVENTORY_REVISION,
		INV_MASTER_ORGANIZATION_ID,
		SERIAL_NUMBER,
		MFG_SERIAL_NUMBER_FLAG,
		LOT_NUMBER,
		QUANTITY,
		UNIT_OF_MEASURE,
		ACCOUNTING_CLASS_CODE,
		INSTANCE_CONDITION_ID,
		INSTANCE_STATUS_ID,
		CUSTOMER_VIEW_FLAG,
		MERCHANT_VIEW_FLAG,
		SELLABLE_FLAG,
		SYSTEM_ID,
		INSTANCE_TYPE_CODE,
		ACTIVE_START_DATE,
		ACTIVE_END_DATE,
		LOCATION_TYPE_CODE,
		LOCATION_ID,
		INV_ORGANIZATION_ID,
		INV_SUBINVENTORY_NAME,
		INV_LOCATOR_ID,
		PA_PROJECT_ID,
		PA_PROJECT_TASK_ID,
		IN_TRANSIT_ORDER_LINE_ID,
		WIP_JOB_ID,
		PO_ORDER_LINE_ID,
		LAST_OE_ORDER_LINE_ID,
		LAST_OE_RMA_LINE_ID,
		LAST_PO_PO_LINE_ID,
		LAST_OE_PO_NUMBER,
		LAST_WIP_JOB_ID,
		LAST_PA_PROJECT_ID,
		LAST_PA_TASK_ID,
		LAST_OE_AGREEMENT_ID,
		INSTALL_DATE,
		MANUALLY_CREATED_FLAG,
		RETURN_BY_DATE,
		ACTUAL_RETURN_DATE,
		CREATION_COMPLETE_FLAG,
		COMPLETENESS_FLAG,
		CONTEXT,
		ATTRIBUTE1,
		ATTRIBUTE2,
		ATTRIBUTE3,
		ATTRIBUTE4,
		ATTRIBUTE5,
		ATTRIBUTE6,
		ATTRIBUTE7,
		ATTRIBUTE8,
		ATTRIBUTE9,
		ATTRIBUTE10,
		ATTRIBUTE11,
		ATTRIBUTE12,
		ATTRIBUTE13,
		ATTRIBUTE14,
		ATTRIBUTE15,
		CREATED_BY,
		CREATION_DATE,
		LAST_UPDATED_BY,
		LAST_UPDATE_DATE,
		LAST_UPDATE_LOGIN,
		OBJECT_VERSION_NUMBER,
		SECURITY_GROUP_ID,
		LAST_TXN_LINE_DETAIL_ID,
		INSTALL_LOCATION_TYPE_CODE,
		INSTALL_LOCATION_ID,
		INSTANCE_USAGE_CODE,
		OWNER_PARTY_SOURCE_TABLE,
		OWNER_PARTY_ID,
		OWNER_PARTY_ACCOUNT_ID,
		LAST_VLD_ORGANIZATION_ID,
		MIGRATED_FLAG,
		REQUEST_ID,
		PROGRAM_APPLICATION_ID,
		PROGRAM_ID,
		PROGRAM_UPDATE_DATE,
		CONFIG_INST_HDR_ID,
		CONFIG_INST_REV_NUM,
		CONFIG_INST_ITEM_ID,
		CONFIG_VALID_STATUS,
		INSTANCE_DESCRIPTION,
		LAST_PURGE_DATE,
		ATTRIBUTE16,
		ATTRIBUTE17,
		ATTRIBUTE18,
		ATTRIBUTE19,
		ATTRIBUTE20,
		ATTRIBUTE21,
		ATTRIBUTE22,
		ATTRIBUTE23,
		ATTRIBUTE24,
		ATTRIBUTE25,
		ATTRIBUTE26,
		ATTRIBUTE27,
		ATTRIBUTE28,
		ATTRIBUTE29,
		ATTRIBUTE30,
		NETWORK_ASSET_FLAG,
		MAINTAINABLE_FLAG,
		PN_LOCATION_ID,
		ASSET_CRITICALITY_CODE,
		CATEGORY_ID,
		EQUIPMENT_GEN_OBJECT_ID,
		INSTANTIATION_FLAG,
		LINEAR_LOCATION_ID,
		OPERATIONAL_LOG_FLAG,
		CHECKIN_STATUS,
		SUPPLIER_WARRANTY_EXP_DATE,
		PURCHASE_UNIT_PRICE,
		PURCHASE_CURRENCY_CODE,
		PAYABLES_UNIT_PRICE,
		PAYABLES_CURRENCY_CODE,
		SALES_UNIT_PRICE,
		SALES_CURRENCY_CODE,
		OPERATIONAL_STATUS_CODE,
		SOURCE_CODE,
		ROUTE_UPDATE_WO_FLAG,
		COST_UPDATE_WO_FLAG,
		ROUTE_COST_EQUAL_FLAG,
		LINEAR_ASSET,
		SEGMENTED,
		ROUTE_QUALITY_RESULT_FLAG,
		ESRI_FEATURE,
		NO_MEASURES_LA,
		ROUTE_LAYER_ID,
		IN_SERVICE_DATE,
		IOT_SYNC_DATE,
        KCA_OPERATION,
       'N' AS IS_DELETED_FLG,
	    cast(NULLIF(KCA_SEQ_ID,'') as numeric(36,0)) as KCA_SEQ_ID,
		kca_seq_date
	from bec_ods_stg.csi_item_instances
	where kca_operation IN ('INSERT','UPDATE') 
	and (nvl(INSTANCE_ID,0),kca_seq_id) in 
	(select nvl(INSTANCE_ID,0) as INSTANCE_ID,max(kca_seq_id) from bec_ods_stg.csi_item_instances 
     where kca_operation IN ('INSERT','UPDATE')
     group by nvl(INSTANCE_ID,0))
);

commit;

-- Soft delete
update bec_ods.csi_item_instances set IS_DELETED_FLG = 'N';
commit;
update bec_ods.csi_item_instances set IS_DELETED_FLG = 'Y'
where (INSTANCE_ID)  in
(
select INSTANCE_ID from bec_raw_dl_ext.csi_item_instances
where (INSTANCE_ID,KCA_SEQ_ID)
in 
(
select INSTANCE_ID,max(KCA_SEQ_ID) as KCA_SEQ_ID 
from bec_raw_dl_ext.csi_item_instances
group by INSTANCE_ID
) 
and kca_operation= 'DELETE'
);
commit;
end;

update bec_etl_ctrl.batch_ods_info
set	last_refresh_date = getdate()
where ods_table_name = 'csi_item_instances';

commit;